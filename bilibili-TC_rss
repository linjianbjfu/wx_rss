<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>bilibili-TC</id>
    <title>哔哩哔哩技术</title>
    <updated>2024-05-05T15:27:03.357Z</updated>
    <generator>awesome</generator>
    <author>
        <name>哔哩哔哩技术</name>
    </author>
    <subtitle>提供B站相关技术的介绍和讲解</subtitle>
    <logo>http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/0?wx_fmt=png</logo>
    <icon>http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/0?wx_fmt=png</icon>
    <entry>
        <title type="html"><![CDATA[B站数据中心网络布线智慧管理平台实践（一）]]></title>
        <id>2247499109_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247499109&amp;idx=1&amp;sn=ec621ad56271e55278076cdd79dc2663&amp;chksm=cf2f3840f858b156073e010971a1e7e3f8b27d123561cfc143d776e906668bdc862ce4230c5f#rd"/>
        <updated>2024-04-29T09:29:07.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>1.背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">前期我们详细介绍了B站在定制化数据中心（R2-AZ2）项目上的探索<sup>[1]</sup>，主要集中在智慧节能数据中心的技术迭代和实施情况。数据中心的高效运作并非孤立存在，它依赖于复杂而精细的互联互通网络，确保数据中心内的服务器、存储和网络设备间的连接。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线系统是实现数据中心互联互通的关键组成部分， 数据中心布线的管理不当问题会造成生产环境交付周期拉长、预留线缆过长、线缆布局混乱、设备安装困难、故障排除和维护时间增加，甚至会影响机柜的气流组织，导致局部过热从而影响电子信息设备的安全运行。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">此外，随着AI技术及业务应用的快速发展，智算中心正在迅速崛起，网络正向大带宽、低延时、低功耗等方向发展，这也意味着对网络和布线系统的要求正在持续提高。</p><p style="word-break: break-all;white-space: normal;">布线系统作为大型数据中心的关键基础设施之一，如何利用数字化管理工具提高其交付及运维管理效率，也是我们一直在思考的问题和探索实践的方向。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1.1 数据中心布线介绍</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在对数据中心生产系统进行综合布线设计前，应先了解业务侧对于网络的需求，确定网络布线的拓扑结构，并按照设计的网络拓扑结构来确定数据中心综合布线的设计方案<sup>[2]</sup>。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015444" data-ratio="0.27314814814814814" data-s="300,640" data-type="png" data-w="864" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOwHicfJ9tOl6icY0ZDcfaiackY9QLG5Flt1Phw76wxbYTqicsYB0vmHxpZQ/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图1 网络布线实施流程图</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">常见有两种布线方法：结构化布线与非结构化布线<sup>[3]</sup>。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">结构化布线通过采用标准化的预定义连接点和路径设计，利用一个或多个配线区域和布线产品（如布线网络机柜、高密度配线架等）为电子信息设备提供基于标准的连接，当电子信息设备移动、增加或改变时，只需要在集中配线区重新跳接线缆，而永久链路部分则不会因设备的移动、增加或改变而变动。结构化布线系统采用高密度的预端接光缆，大大减少了机房内的光缆数量，但布线系统的设计和安装需要更多的时间和成本，且同一链路因增加了中间连接点可能会降低网络传输质量。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">非结构化布线也称为点对点布线，顾名思义，这种类型的布线系统不使用任何预定义的标准、连接点或路径，直接进行端到端的线缆连接。与结构化布线相比，非结构化布线系统的安装成本较低，安装时间也较短，但后期运营及变动的成本较高。&nbsp;</p><p style="word-break: break-all;white-space: normal;">B站目前根据在不同的机房环境和业务对于网络需求，综合考虑成本、交付周期、现场环境等因素，灵活选择布线方式。针对常规服务器机柜区域通常优先采用非结构化布线，对于重要等级的网络核心机柜区域会考虑采用结构化布线设计来优化线缆数量和后期运营管理。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-croporisrc="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjO6ujJ7objicRjYlYDvA3R3V5Z7vpxiaUiag0Asibrl03gUNbZQWiaJ935y3g/0?wx_fmt=jpeg&amp;from=appmsg" data-cropx1="0" data-cropx2="1280" data-cropy1="93.0909090909091" data-cropy2="1726.8363636363636" data-imgfileid="100015445" data-ratio="1.275925925925926" data-s="300,640" data-type="jpeg" data-w="1080" style="vertical-align: middle;width: 550px;height: 702px;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjO0PlePYN2mI4amiac27ibQv2icpMCrMwC9uLUbYrgBSiciawZy9Te6C53S4w/640?wx_fmt=jpeg"></p></div><div style="text-align: center;"><p><sup>图2 网络核心机柜布线现场图</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1.2 B站布线智慧管理平台开发</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">针对单楼栋的数据中心网络布线任务，一般按照业务交付节奏，分若干批次布线工程来完成。在处理每个批次的布线工程时，全生命周期信息流转和管理依赖不同角色的人员手动通过办公软件工具完成，面对当今复杂的中大型数据中心集群生产系统快速交付需求时，有如下的问题和挑战：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>（1）文件标准化和准确度问题：</strong>在布线工程过程中，文件流转的标准化和准确度不足可能导致信息缺失或错误。我们需要确保文件格式、数据内容等达到一定的标准，并减少人为操作导致的误差。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>（2）路由规划效率问题：</strong>目前的手动规划方式效率较低，容易造成路由长度预估错误，导致实际施工中的误差和额外工作量。我们需要提高路由规划的自动化和准确性，以减少人工干预和误差。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>（3）布线管理复杂度高：</strong>由于涉及的人员、角色和基础数据众多，布线管理成为一项繁琐且周期较长的工作。传统的单批次布线工程和交付信息成为孤岛，导致历史机柜布线状态和信息不完整，不利于提高机房生产环境交付效率和投运后的运维管理及布线优化。我们需要建立更高效的信息管理和数据共享机制，以实现更顺畅的信息传递和更优化的布线策略。</p><p style="word-break: break-all;white-space: normal;">基于以上背景，结合我们实际的布线工程管理经验，提出B站数据中心网络布线智慧管理平台的开发项目，旨在将线下的网络布线过程实现数字化、可视化、智能化，使得专业技术人员能够轻松、快速、准确完成布线规划、管理和运维工作。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>2.布线智慧管理平台</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">针对B站布线管理平台，梳理完整的布线管理流程，以下为流程示意图。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="521" data-imgfileid="100015446" data-ratio="0.8805555555555555" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 578px;height: 509px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOvTYfFax8S6gBswbjWtXFVOxfOkdicOyWnmibjiaSdrZ59g0piaKnBppRGw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图3 布线管理流程示意图</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">B站布线智慧功能平台分功能模块、分期进行快速开发迭代，本文将重点阐述红框的<strong>布线路由自动化模块</strong>，这部分数据的准确性将直接影响到整个布线任务的最终效果。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.1 功能一：基础信息维护</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线管理涉及到的对象包括但不限于以下内容信息：</p><ul class="list-paddingleft-2" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">线材</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">机柜</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">边柜</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">通道</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">立柱</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">列头柜</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">列尾柜</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">包间桥架</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">跨包间生产桥架</p></li><li><p style="word-break: break-all;">……</p></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015447" data-ratio="0.8958333333333334" data-s="300,640" data-type="png" data-w="576" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOy4KAPa0weNAgxmDX7yjVYLpicZmNaKAumAYxB7h7z9d7v40QicQnwIUg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图4 机柜平面布局&amp;生产桥架平面图</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">对以上基础数据，我们提取与布线工程强相关的基础数据，整合抽象若干数据模型，如机柜模型、通道模型、跨包间互联模型等，结合机柜平面布局&amp;生产桥架平面图等，由运维人员根据不同物理环境情况，提前维护以上基础数据信息，为布线项目计算打下基础。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.2 功能二：布线路由自动化计算</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>方法一：场景归纳计算法</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">为自动完成布线路由的计算，B站采用高性价比的方式，快速构建简单明晰的数据中心包间布局示意图，运维人员通过新增行列形式，绘制包间物理拓布局结构，并关联基础数据，建立立柱、通道、机柜的相对位置关系。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="330" data-imgfileid="100015448" data-ratio="0.42314814814814816" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 578px;height: 245px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjO9diaOC8cQczhjQoykytxKHc9WxZlHPfFTOEYJZL7fnsUicATwElUSdxw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图5 平台上构建的机房布局界面展示</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">总结日常的布线需求，整合抽象6种高频布线的场景，分别为：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">同包间同通道布线</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">同包间[指定路由方向]/[不指定路由方向]的跨通道布线</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">跨包间不指定路由的布线，其中起始机柜和终点机柜与包间桥架出口均在同一列</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">跨包间不指定路由的布线，其中起始机柜或终点机柜与包间桥架出口不在同一列</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">跨包间指定路由的布线，起始机柜和终点机柜与包间桥架出口均不在同一列</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">其他场景可灵活添加。</p></li></ul><p style="word-break: break-all;white-space: normal;">针对不同场景，定义计算布线距离的统一公式，选择距离最短的布线路由。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>方法二：最短路径寻优法</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线路由的计算可转化为图论里的最优路径问题求解，相比于方法一的场景归纳计算法，计算效率更高，适应的机房布局和布线场景更广，但难点在于如何将实际的工程问题转化为数学问题并求解。</p><p style="word-break: break-all;white-space: normal;">我们通过先在设计阶段对强弱电桥架和机房机柜、配电柜进行分段有序编号，再于布线规划阶段对桥架、机柜、配电柜等涉及线缆连接的设备建立数学关系模型，明确相互之间的几何关系，并输入各段桥架布线长度的初始数据，最后通过最优路径规划算法，自动计算任意设备之间布线的最短路径，输出规划路径结果。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015452" data-ratio="1.4989858012170385" data-s="300,640" data-type="png" data-w="986" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOriaNFB510He156R6ZiaKvgxzX5OP63Y2T9E6QEIiaFEqzPian5fEjWLmYw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图6 最短路径寻优流程图</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.3 功能三：新建布线任务</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>2.3.1 任务生成</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">以任务的形式在平台上生成单布线需求，针对单布线任务，可按照布线场景批量创建布线明细（如机柜内垂直布线，业务交换机到网络核心跨机柜布线，网络核心间跨机柜布线等场景）。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线明细中明确以下核心信息：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线任务名称：命名区分任务需求</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线的起点信息：包括起始包间、起始机柜、起始U位</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线的终点信息：包括终点包间、终点机柜、终点U位</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">线材类型：六类非屏蔽网线，LC-LC，AOC，MPO……</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">布线线缆编号：自动生成</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">……</p><p style="word-break: break-all;white-space: normal;">明确好布线基础信息后，由系统自动计算最短路径并输出布线长度，给出所有布线任务的清单明细。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015449" data-ratio="1.0204918032786885" data-s="300,640" data-type="png" data-w="488" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjO8ExuVx4z92rrONEibbONM2tn4gpF2OXmom3Er5OkmDhlpXQZchebQ8w/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图7 平台上新建布线明细界面展示</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>2.3.2 任务执行</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">平台布线任务生成后，进行任务执行阶段，通过流程审批，将过程管理文件数字化、平台化，实时更新布线工程相关信息，直至最终的布线验收和交付使用。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.4 功能四：布线运维管理</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">前序布线任务完成后，布线的基础信息数据将持续为后续的布线运维管理提供价值。通过可视化工具可快速了解机房的布线关键信息，判断业务环境网络布线的交付情况。通过数据分析，可进一步分析线缆类型与连接设备端口是否匹配、不同类型/品牌/批次线缆故障率、布线成本趋势等指标，助力故障线路寻源工作。</p><p style="word-break: break-all;white-space: normal;"><br></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015450" data-ratio="0.7589189189189189" data-s="300,640" data-type="png" data-w="925" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOv7TTRcUH0aia7iaYDYsQ5h11pvh37p9licBdLGKGFDXlBpJNfBz1a3ibGQ/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图8 布线运维管理可视化界面示意</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>3.平台应用及未来展望</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">目前B站布线智慧管理平台1.0版本已正式上线，我们提交的发明专利《机房布线方法和系统》处于实质受审阶段，已实现布线和机房信息平台化、布线路由和长度自动化计算等功能，不仅大大提升了布线工程实施效率和效果，而且平台自动规划的路由长度较前期手工计算的长度平均减少10%，从而帮助网络和数据中心运维管理人员做好布线降本和布线系统管理工作。</p><p style="word-break: break-all;white-space: normal;">未来我们将持续整合布线项目的实施、交付及网络运维经验，致力于打通网管、IDC运维管理与布线管理之间的信息对接和应用。通过这种方式，我们将构建一个更全面、更智能、更强大的B站布线管理平台，从而助力实现网络布线的快速交付、智能运维和精细管理。</p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>参考：</strong></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[1] <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247485294&amp;idx=1&amp;sn=53369c1af5c2fcb3a5eab79113a46256&amp;chksm=cf2cc24bf85b4b5d9a4e20bb4521bd8c0b1b3ccbda6f99855af02c534828fb6290749e6d1ea1&amp;scene=21#wechat_redirect" textvalue="新一代智慧节能数据中心B站定制化项目实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">新一代智慧节能数据中心B站定制化项目实践</a></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[2] 卢磊. 数据中心网络综合布线技术研究. 电信快报：网络与通信 8(2019):5.</p><p style="word-break: break-all;white-space: normal;">[3] <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzA4NDkwNDI2OQ==&amp;mid=2651020930&amp;idx=1&amp;sn=fcfbd25aaf24026365e3e53546a5524c&amp;scene=21#wechat_redirect" textvalue="数据中心应该使用哪种布线方式" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">数据中心应该使用哪种布线方式</a></p></div><p style="white-space: normal;"><br></p><p style="white-space: normal;"><br></p><div style="text-align: center;font-size: 12px;color: rgb(160, 160, 160);padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;">-End-</p><p style="word-break: break-all;">作者丨涛帅、蕾木头</p></div><p style="white-space: normal;"><br></p><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>大家在数据中心布线管理过程中遇到的困难点和解决办法有哪些？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>5月7日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 45%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015451" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RWYdPWnbrvBWadyOOFAQjOjwWZrg1rSRicAzgjF50pxjxibMXOs13S3Y09icC2z6ZuU1cZh0MUabDxg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494576&amp;idx=1&amp;sn=c636ef27b1b88469c0d132c43465492b&amp;chksm=cf2f2e95f858a78304eb877d65dd1800fa30b09fc66ed35802428e9d3c8aa78754bbe1cf9370&amp;scene=21#wechat_redirect" textvalue="DWDM技术在B站基础工程的落地实践之路" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">DWDM技术在B站基础工程的落地实践之路</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247489557&amp;idx=2&amp;sn=63dfc1a9feac637dbebb6f1c0f416c98&amp;chksm=cf2cdd30f85b5426701aca754b6c9c897cb59718e96442bf2944e84f3ee24ed9c202ad94ba51&amp;scene=21#wechat_redirect" textvalue="新一代智慧节能数据中心B站定制化项目实践（二）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">新一代智慧节能数据中心B站定制化项目实践（二）</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494494&amp;idx=1&amp;sn=8ff137c417bf0548210ed969b3316b06&amp;chksm=cf2f2e7bf858a76d2cbab2862a8df2ae0646017749acd123c93dc27cba5f544ab0ea4145e41c&amp;scene=21#wechat_redirect" textvalue="新一代智慧节能数据中心实践（三）— 液冷篇" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">新一代智慧节能数据中心实践（三）— 液冷篇</a></p></li></ul></div></div></div></div><p><br></p><div style="margin-bottom: 0px;outline: 0px;line-height: 1.6;font-size: 16px;visibility: visible;"><div style="outline: 0px;line-height: 1.6;visibility: visible;"><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="outline: 0px;"><br style="outline: 0px;"></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="235" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p></div></div></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>通用工程</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[NameNode锁细粒度优化在B站的实践]]></title>
        <id>2247499091_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247499091&amp;idx=1&amp;sn=4b0ba4f7fdecea40f9341d118055d54a&amp;chksm=cf2f3876f858b160fdce45ea26538e46cd0d5476e508d5f45568da4c9a23bc7b3dfd4a8e847f#rd"/>
        <updated>2024-04-26T03:40:11.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>1. 背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">随着业务的高速发展，针对HDFS元数据的访问请求量呈指数级上升。在之前的工作中，我们已经通过引入HDFS Federation和Router机制实现NameNode的平行扩容，在一定程度上满足了元数据的扩容需求；也通过引入Observer NameNode读写分离架构提升单组NameSpace的读写能力，在一定程度上减缓了读写压力。但随着业务场景的发展变化，NameSpace数量也在上升至30+组后，Active+Standby+Observer NameNode 的架构已经无法满足所有的元数据读写场景，我们必须考虑提升NameNode读写能力，来应对不断上升的元数据读写要求。</p><p style="word-break: break-all;white-space: normal;">如图1-1 所展示的B站离线存储整体架构所示，随着业务的不断增量发展，通过引入HDFS Router机制实现NameNode的平行扩容，目前NameSpace的数量已经超过30+组，总存储量EB级，每日请求访问量超过200亿次。各个NameSpace之间的读写请求更是分布非常不均衡，在一些特殊场景下，部分NameSpace的整体负载更高。如Flink任务的CheckPoint 场景，Spark和MR任务的log日志上传场景，这两类场景的数据写入要求要远远高于普通场景。此外还有部分数据回刷场景，存在短时间写入请求增加300%以上的情况，极易触发NameNode的写入性能瓶颈，影响其他任务的正常访问。为了应对这个问题，我们针对性的提出了NameNode的读写性能提升方案。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015424" data-ratio="0.8205854579792257" data-s="300,640" data-type="jpeg" data-w="1059" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQmp3uAxIIKliaSobvUmEWIMc9zq0UXzQKfBzaNUa2Hd9b5IWSicLAnbCA/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图1-1 B站HDFS整体架构图</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>2. HDFS 细粒度锁优化整体方案</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.1 面临的问题</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">NameNode是整个HDFS的核心组件，集中管理HDFS集群的所有元数据，主要包括文件系统的目录树、数据块集合和分布以及整个集群的拓扑结构。HDFS在对NameNode的实现上做了大胆取舍，如图2-1所示，锁机制上使用全局锁来统一来控制并发读写。这样处理的优势非常明显，全局锁进一步简化锁模型，不需要额外考虑锁依赖关系，同时降低复杂度，减少工程量。但是问题比优势更加突出，核心问题就是全局唯一锁制约性能提升。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015425" data-ratio="0.5935185185185186" data-s="300,640" data-type="jpeg" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQVfkib0ic3k5RVWEVKFzmgc8v8YCT2Th5icXibQLO2alh62Z76aCRcg70Ag/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-1 B站HDFS整体架构图</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在多年的HDFS实践工作中，我们发现NameNode全局唯一的读写锁已经成为NameNode读写性能最大瓶颈之一，社区已经做了很多的工作来优化相关性能，如将一些日志操作异步化，移动日志操作到锁外，针对DU请求采用分段锁，大删除异步化等一系列优化措施，但对于我们这种数据量的HDFS集群来说，仍然难以满足部分生产场景。为了进一步提升HDFS读写性能，满足业务场景，我们计划对全局锁进行细粒度拆分，为此我们也面临着许多困难。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">首先是问题复杂度高，Hadoop发展到今天已经超过十年，其中HDFS经过多次迭代演进，架构已经非常复杂。针对NameNode组件来说，架构上模块划分不够清晰，内部核心数据结构和工作线程之间耦合非常严重，实现细节上，还存在大量相互依赖，不一而足。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">其次是社区的动力不足，在全局唯一的读写锁的扩展性问题上，社区做过多次尝试，主要就有 HDFS-8966：Separate the lock used in namespace and block management layer 和 HDFS-5453：Support fine grain locking in FSNamesystem 等方面的尝试，但是并没有产出可以进行生产化部署的成果。具体原因还是动力不足，因为NameNode性能针对小规模部署的集群来说大体上已经足够，也有通过Federation和Router机制进行扩展，满足一定的需求。</p><p style="word-break: break-all;white-space: normal;">为了解决这个难题，我们参考了业界的拆锁方案和Alluxio的LockPool实现机制，计划实现针对NameNode全局唯一锁的细粒度拆分。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.2 设计选型</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">为了更好地理解使用全局锁存在的问题，首先梳理全局锁管理的主要数据结构，大致分成三类：</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;word-break: break-all;">NameSpace目录树：文件系统的全局目录视图。获取目录树上任一节点的信息必须先拿到全局读锁；目录树上任一节点新增、删除、修改都必须先拿到全局写锁。</p></li><li><p style="margin-bottom: 15px;word-break: break-all;">BlockPool层数据块集合：文件系统的全量数据信息。获取其中任一数据块信息必须先拿到全局读锁；新增、删除，修改都必须先拿到全局写锁。</p></li><li><p style="margin-bottom: 15px;word-break: break-all;">集群信息：HDFS集群节点信息的集合。获取节点信息等必须先拿到全局读锁；注册，下线或者变更节点信息请求处理时必须先拿到全局写锁。</p></li></ol><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">具体实现上，NameNode使用了JDK提供的可重入读写锁（ReentrantReadWriteLock），ReentrantReadWriteLock对并行请求有严格限制，支持读请求并行处理，写请求具有排他性。针对不同RPC请求的处理逻辑，按照需要获取锁粒度，我们可以把所有请求抽象为全局读锁和全局写锁两类。全局读锁包括客户端请求（getListing/getBlockLocations/getFileInfo）、服务管理接口（monitorHealth/getServiceStatus）等；全局写锁则包括客户端写请求（create/mkdir/rename/append/truncate/complete/recoverLease）、服务管理接口（transitionToActive/transitionToStandby/setSafeMode）和主从节点之间请求（rollEditLog）等。在一次RPC处理过程中，如果不能及时获取到锁，这次RPC将处于排队等待状态，直到成功获得锁，锁等待时间直接影响请求响应性能，极端场景下如果长时间不能获得锁，将造成IPC队列堆积，TCP连接队列被打满，客户端出现请求卡住，新建连接超时失败等各种异常问题。从全局来看，写锁因为排它对性能影响更加明显。如果当前有写请求正在被处理，其他所有请求都必须排队等待，直到写请求被处理完成释放锁后再竞争全局锁。因此我们希望对全局锁进行细粒度划分，最终实现NameNode服务的大部分的RPC请求都能并行处理。</p><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">我们计划通过3步实现 NameNode 锁的细粒度划分，如图2-2所示。</p><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">第一步，将NameNode 全局锁拆分为 Namespace层读写锁和 BlockPool层读写锁；</p><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">第二部，将NameSpace读写锁拆成颗粒度更细的Inode层的读写锁；</p><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">第三步，将BlockPool层读写锁也拆成更细粒度的读写锁；</p><p style="word-break: break-all;white-space: normal;">目前我们已经基本完成第一部分和第二部分的工作。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015428" data-ratio="0.9648148148148148" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQ82spd9tlb1gO5INs8jgPYKrfluQibz1jASkE0bEIicRG95e2xgzmpjLA/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-2 NameNode 锁优化过程</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>3. HDFS 细粒度锁优化实现</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.1 NameNode全局唯一锁拆成</strong></p><p><strong>NameSpace层锁和BlockPool层锁</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在实践中发现，客户端请求访问NameNode过程中，部分请求需要同时访Namespace层和BlockPool层，有些请求只需要访问 Namespace层，同时服务端请求如DataNode的IBR/BlockReport等请求实际上也只需要访问 BlockPool层，这两层的锁调用可以拆分，实现对两层数据的并行访问。因此拆锁的第一步， 就是将NameNode 全局锁拆分为 Namespace层读写锁和 BlockPool层读写锁，如图2-3所示，通过这种拆分实现访问的这两层数据的RPC请求能够并⾏处理。在实践过程中，我们引入了BlockManagerLock，单独处理BlockPool层锁事件。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015426" data-ratio="0.4287037037037037" data-s="300,640" data-type="jpeg" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQSqIBWloyBSPtnQiajJVVzUlg3QmibKpZ3mqQSCwAVv1vTkNc1x3W6HaQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-3&nbsp;NameNode全局唯一锁拆成NameSpace层锁和BlockPool层锁</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在实际的拆锁过程中，我们发现NameSpace层和BlockPool层之间有非常多的耦合，这里我们参考了社区的一部分工作HDFS-8966：Separate the lock used in namespace and block management layer, 已经帮助我们解除了部分的依赖，除了社区列出来的这部分依赖之外我们还发现一些BlockPool层对NameSpace层的反相依赖，主要是Block的副本信息和storagePolicy属性信息，这块我们将这部分信息在BlockPool层进行冗余存储，同时确保发生变更时NameSpace层的信息及时同步至BlockPool层。在解除了BlockPool层对NameSpace层的反相依赖后，开始针对不同类型的请求获取何种类型的锁进行区分，如图2-4所示。</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">NameSpace层请求(getListing/getFileInfo等请求)，只需要获取NameSpace层锁；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">BlockPool层请求(BlockReport/IncrementalBlockReport等请求)，只需要获取BlockPool层锁，这块我们发现有块上报过程中，有一段更新Quota的逻辑需要获取NameSpace层锁，我们无法做到完美的适配，考虑到我们的Quota采用的外置计算的方式，所以做了相应的取舍，只获取了BlockPool层的锁；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">同时访问NameSpace层和BlockPool层的请求(setReplication/getBlockLocation)，需要同时获取NameSpace层的锁和BlockPool层的锁。</p></li></ol><p style="word-break: break-all;white-space: normal;">通过对不同请求按不同类型锁要求划分后，我们基本可以做到访问部分不同层数据的请求的并行执行，但仍然有2个问题需要解决。首先是死锁问题，为此我们确保所有请求的加锁顺序的一致性，所有需要同时获取NameSpace层锁和BlockPool层的请求都是NameSpace层锁在前，BlockPool层的锁在后；其次是一致性问题，NameNode内部本身是写一致性，并发读取场景，针对同时访问NameSpace层和BlockPool层的请求，需要确保NameSpace层加锁范围完全包含BlockPool层加锁范围，防止读取到中间状态。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015427" data-ratio="0.3353884093711467" data-s="300,640" data-type="jpeg" data-w="811" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQ3tnp6hs9Dz0aUt6GccmvFLqHawQhb5ibaPW27OQoG8qO2dqwzxlaIWg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-4 不同类型的请求加锁场景</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">通过上述这种方式，我们基本实现了BlockPool层和NameSpace层的锁拆分，当前这部分优化策略已经在生产环境运行了一段时间，NameNode整体性能大约提升了50%左右。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.2 NameSpace层锁拆分成INode粒度锁</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在实现了FSN层和BP层锁拆分之后，NameNode性能已经有了一定的提升，生产环境中对HDFS的NameNode元数据请求的rpc processtime和queuetime也有明显的下降，但仍然有一些场景无法满足，因此我们继续优化，对NameSpace层的锁进行更细粒度的拆分如图2-5所示，将锁细粒度到INode层，希望能进一步提升NameSpace层RPC并发能力，提升NameNode整体写入能力。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015429" data-ratio="0.4083333333333333" data-s="300,640" data-type="jpeg" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQtiaaovLmXglDkwoAxP5vZ3FXUb3WGSbsctfRMX0gOQoDNyatOWhY6MA/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-5 NameSpace层锁细粒度拆分</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">要将NameSpace层锁拆分到INode层级粒度，必然要为对应的INode分配锁对象，在这里我们面临了许多问题。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">首先是内存限制，我们目前单组Namespace元数据容量阈值基本在10亿左右，如果每个INode分配一个INode锁，单是INode锁的内存几乎就需要120GB左右的内存，再加上本身NameNode就非常耗费内存，当前的服务器类型很难满足。为了解决这个问题，我们参考了 Alluxio 的LockPool 的概念，也就是有一个锁资源池，每个INode需要Lock加锁的时候，就去资源池里申请锁，同时引用计数会增加，用完之后unlock掉的时候，引用计数会减少，同时配置不同的高低水位，定期清理掉引用计数为0的锁，确保总体内存可控。</p><p style="word-break: break-all;white-space: normal;">其次是锁对象的管理，这方面我们引入了INodeLockManager 用于管理INode和锁对象的之间的映射，我们通过INodeLockManager新增了INode锁的LockPool 和 Edge锁的LockPool，如图2-6所示，管理整个NameSpace层的INode层级的细粒度锁。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015430" data-ratio="0.41682785299806574" data-s="300,640" data-type="png" data-w="1034" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQIicV4hBYB8nficcvZFibZpgqHzuoukCSJFicpAnibicibUhx6vVp4x7fAsNnw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-6 NameSpace层的INode层级的细粒度锁管理</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">完成了锁对象的管理后，Namespace层锁细粒度拆分剩下的问题都是如何预防死锁和数据错乱，因此我们对加锁行为进行规划，总体遵循如下原则。</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">普通Client端的RPC请求采用自上而下的加锁方式，对特殊操作如Rename等操作进行特殊处理；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Client端的RPC请求进行全链路加锁，部分请求考虑最后的INode和Edge加写锁；</p></li></ul><p style="word-break: break-all;white-space: normal;">如图2-7所示，我们配置了3种类型的锁，分别时Read锁，Write_Inode 锁和 WRITE_EDGE锁分别应对不同类型的客户端RPC请求。针对读请求，我们正向遍历INodeTree从ROOT节点开始依次加锁 对对整个路径上的INode和Edge都加读锁；针对addBlock ，setReplication 这类不影响INodeTree的请求，我们也是正向遍历INodeTree从ROOT节点开始依次加读锁，但是对最后一个INode加写锁；针对create ，mkdir请求，我们正向遍历INodeTree ，对最后INode节点和最后的Edge都加写锁，如果最后INode不存在，对最后的Edge也需要加写锁。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015433" data-ratio="0.30277777777777776" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQsIMznEau7MEBYL9iapFdpuutdWVa6tcHFp3RaNibYhYrCOicFujJFcaRA/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-7 INodeLock 加锁方式</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">除了访问单个路径的请求，还有rename等访问多个路径的rpc请求，如图2-8所示，从 /a/b/c rename 成 /a/b/e，我们对这种场景做了特殊处理。我们首先路径/a/b/c和/a/b/e按字典序确定先后，再自上而下加锁，如图2-8所示，路径/a/b/c排序在前，我们先对/a/b/c 路径加锁，正向遍历INodeTree从ROOT节点开始依次加锁，边b-c，INode c都加上写锁,路径/a/b/e排序在后，我们在对路径/a/b/c加锁完成后，对路径/a/b/e加锁，同样遍历INodeTree，Edge b→e加上写锁，INode e 由于还未存在，则放弃加锁；</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015431" data-ratio="0.3323045267489712" data-s="300,640" data-type="png" data-w="972" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQvClLZrcGOVEXhVEibW3oia9aVWymerBpvfDZN5v18zQHTuia0kZufAfEQ/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-8 Rename RPC操作加锁方式</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在上述的工作中，我们完成了不同请求的加锁方式，针对部份加锁场景中存在的INode缺失场景（如文件不存在等场景），如下图2-9所示针对相对典型的是create请求列举了不同RPC类型的加锁逻辑。</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">create 路径/a/b/c文件，如果当前已经存在存在/a/b 路径，则最终会在Edge b-&gt;c 加写锁；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">create 路径/a/b/c文件，如果已经存在/a/b/c路径，则最终会在Edge b→c 和INode c上加写锁；</p></li><li><p style="word-break: break-all;">create 路径/a/b/c文件，如果只存在 /a 路径，则会在Edge a-&gt;b 这条边上加上写锁。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015432" data-ratio="0.3990740740740741" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQKzPYhIdpc67VOL5dNWAn3psITMMcTo2aIMMMu7NAVpgHMdpx3ZhSbw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图 2-9 不同RPC类型的加锁逻辑举例</sup></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">通过实现上述2步拆锁过程，NameNode性能已经有了很大提升，如图2-10展示了我们在测试环境中的性能对比，经过Namespace层读写锁和BlockPool层读写锁拆分后，相比于社区版本，单NameSpace的写性能大约提升了50% ，经过Namespace层细粒度锁拆分后，写性能相比于社区版本有3倍左右的提升，此时NameNode性能瓶颈已经集中在Edits和审计日志同步以及BlockPool层的本身的锁竞争上。在实际生产过程中，我们把之前需要2组NameSpace支持的任务日志采集路径收归为一组NamesSpace支持，在写入QPS上升3倍的场景下，整体rpc queue time 下降了90%，整体性能有很大的提升。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015435" data-ratio="0.2995110024449878" data-s="300,640" data-type="png" data-w="818" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQcWv1icfRzQPPuWicBZ83kOayv4nvNApIZ6piaLh0GIjM65mkPLgZjH4eQ/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;"><p><sup>图2-10 锁优化性能对比</sup></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>四. 总结与展望</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">NameNode的性能优化已经告一段落了，第一步和第二部的拆锁已经在我们的生产集群上稳定运行了一段时间，整体性能提升明显，整体RPC Queue Time相比于拆锁之前有数量级的下降，当前已经可以支持绝大多数应用场景，包括之前的描述的任务日志聚合和Flink CheckPoint 路径等场景，在接下来计划中，我们也正在考虑是否将BlockPool层锁做进一步细粒度拆分，进一步提升NameNode的性能。</p><p style="word-break: break-all;white-space: normal;">同时考虑到NameNode元数据都存储在内存中，限制了NameNode元数据总量的扩展<span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.034em;">，特别是小文件场景，我们也将在未来规划引入Ozone或者将NameNode的元数据信息持久化至RocksDB或者KV中，进一步提升单组Namespace的承载量彻底解决小文件问题。</span></p></div><p style="white-space: normal;">&nbsp;&nbsp;<br></p><p style="white-space: normal;text-align: center;line-height: 2em;"><span style="font-size: 12px;color: rgb(136, 136, 136);">-End-</span></p><p style="white-space: normal;text-align: center;line-height: 2em;"><span style="font-size: 12px;color: rgb(136, 136, 136);">作者丨云镜</span><span style="font-size: 12px;color: rgb(136, 136, 136);"></span><br></p><p style="white-space: normal;text-align: center;"><span style="font-size: 12px;"><br></span></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>你认为存储系统元数据访问性能和承载能力哪个更重要？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月30日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 45%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015434" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RBaBrmBePaLuEWOKGQKbLQNms1tgQphdLfpy7S4WBKc2KqIickCbhVDW0KdlCZENrJyiapn4HJv3ZQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247493947&amp;idx=1&amp;sn=58a9ac2bac9ca81cad2f5d273968bd97&amp;chksm=cf2f2c1ef858a5088a9b0b73cbe29bca0c471a4f7724b2b3ae350ad7b23facbee3c15eeb8797&amp;scene=21#wechat_redirect" textvalue="HDFS EC在B站的实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">HDFS EC在B站的实践</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247484696&amp;idx=1&amp;sn=e659e925f48af26562b7113314571e84&amp;chksm=cf2cc03df85b492b76487f837b26154b9a8fd69146276229255c256d6afd9838ae9e4de0c6e1&amp;scene=21#wechat_redirect" textvalue="HDFS在B站的探索和实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">HDFS在B站的探索和实践</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498930&amp;idx=1&amp;sn=90c621ef75f2605da763f2742c45b805&amp;chksm=cf2f3997f858b08106ebc33301e8a09639af50698cdc9836db56fcc359ecb21258b5f121aa0e&amp;scene=21#wechat_redirect" textvalue="Flink Keyed State的优化与实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Flink Keyed State的优化与实践</a></p></li></ul></div></div></div></div><p><br></p><div style="margin-bottom: 0px;outline: 0px;line-height: 1.6;font-size: 16px;visibility: visible;"><div style="outline: 0px;line-height: 1.6;visibility: visible;"><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="outline: 0px;"><br style="outline: 0px;"></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="234" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p></div></div></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>大数据</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[B站自研数字版权管理方案完成Cartesian的Farncombe Security™安全审计]]></title>
        <id>2247499070_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247499070&amp;idx=1&amp;sn=a3958a7fb0b1499d1862159506241e50&amp;chksm=cf2f381bf858b10d7b431b9e51e9d57a9ce34f2da8fdac3a4628affe7799e5bccaa0950d618a#rd"/>
        <updated>2024-04-24T14:38:15.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>2024年4月，bilibili自研的软件级数字版权管理方案BiliDRM顺利完成了知名第三方内容安全审计专家Cartesian的审查。</strong></span></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Cartesian 的 Farncombe Security™ Audit是一种独立的、行业认可的审计方法，用于审计内容保护解决方案（CAS或DRM）、多DRM服务、流媒体解决方案和端到端内容分发平台的安全性。20多年来，Cartesian一直执行符合好莱坞主要影视公司严格标准的安全审查，此次审核中，Cartesian对BiliDRM的系统架构、账号安全、客户端安全、生产和开发环境安全、运维安全等方面都进行了严格的审计，BiliDRM各方面安全性都通过了Cartesian的审核。</p><p style="word-break: break-all;white-space: normal;">Farncombe Security™ Audit认证标记可确保完成安全审计，并提供可靠的Cartesian审计报告。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015418" data-ratio="0.6333333333333333" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;display: inline;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RgiaGASwRGwW9guScUbx1T6pfyFKxE6ibrT0tqvoZSSiaPW5nXF978ibf45cibV03SjxEyrG3xdRxqwkA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>关于BiliDRM</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">BiliDRM是bilibili于2022年开始自研的软件级数字版权管理方案，支持iOS、Android、浏览器等多端设备的内容保护，bilibili通过BiliDRM与商业级DRM方案Fairplay和Widevine L1组合的混合方案，全方面保护数字内容版权，目前已应用于对迪斯尼、环球、BBC等影视公司的内容提供保护。</p></div><p style="white-space: normal;"><br></p><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>关于Cartesian</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015419" data-ratio="0.16228070175438597" data-s="300,640" data-type="png" data-w="456" style="vertical-align: middle;width: 380px;display: inline;height: 62px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RgiaGASwRGwW9guScUbx1T6eia5U1Uibcd4JmmWxHLRrjndFfVzibulmB2QAB1sX8rbCy0k1NsmIkJXQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">Cartesian 是一家为全球通信、技术和数字媒体行业的领先企业提供咨询服务和管理解决方案的专业提供商。Cartesian 将技术与创新联系起来，帮助客户寻求增长并取得更多成就。Cartesian 的内容安全服务包括反盗版调查服务、水印稳健性测试、证书共享检测和预防、合同合规性测试、地理屏蔽测试和Farncombe security™审核。客户包括电视广播公司、视频服务提供商、内容分销商、解决方案供应商和网络运营商。该公司在波士顿、堪萨斯城、伦敦、纽约和巴黎设有办事处。有关该公司及其服务的更多信息，请访问<span style="text-decoration: underline;">www.cartesian.com</span>。&nbsp;</p></div><p style="white-space: normal;"><br></p></div><p class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/0?wx_fmt=png" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="0" data-is_biz_ban="0"></mp-common-profile></p><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>哔哩哔哩技术</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[B站下行CDN架构的探索与应用]]></title>
        <id>2247499058_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247499058&amp;idx=1&amp;sn=ad7ac366b74ce4c2751bd94198110ab6&amp;chksm=cf2f3817f858b10119543aaf38f3958af1e97755e924246da7e164d1ccad4c683b01d5730aba#rd"/>
        <updated>2024-04-22T13:05:01.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 28.169%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsynC0ic1ibX86lfTDcfS2T8cxJo7Ie4g5XFY0F8p7BiaMkHlPLH7Z5sLfEg/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015375" data-ratio="1.2862903225806452" data-s="300,640" data-type="jpeg" data-w="992" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsynC0ic1ibX86lfTDcfS2T8cxJo7Ie4g5XFY0F8p7BiaMkHlPLH7Z5sLfEg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>蔡尚志</p></div><div style="margin-top: 5px;text-align: justify;font-size: 12px;"><p style="text-align: center;white-space: normal;">哔哩哔哩资深开发工程师</p></div></div></div></div></div><p style="white-space: normal;"><br></p><div style="line-height: 1.6;font-size: 16px;"><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 53%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>刘勇江</p></div><div style="margin-top: 5px;font-size: 12px;"><p style="text-align: left;">哔哩哔哩高级开发工程师</p></div></div></div></div><div style="display: inline-block;vertical-align: middle;width: 32%;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;background-position: 0% 25.8436%;background-repeat: no-repeat;background-size: 100%;overflow: hidden;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyWc4zibRIAFT4RsjRJ6x8uwAiaIEH0Q7XBNbbxFa6u3BFzFLSzk3O8Qwg/640?wx_fmt=png&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img data-imgfileid="100015409" data-ratio="1.3018518518518518" data-s="300,640" data-type="png" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyWc4zibRIAFT4RsjRJ6x8uwAiaIEH0Q7XBNbbxFa6u3BFzFLSzk3O8Qwg/640?wx_fmt=png&amp;from=appmsg"></p></div></div><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div></div></div></div><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 35.4532%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy2cpkew7UlYdURUudqMJKAaekooQdPpEJ9ib4UZtGGjoauTLxPyLmjZw/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015377" data-ratio="1.2864321608040201" data-s="300,640" data-type="jpeg" data-w="995" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy2cpkew7UlYdURUudqMJKAaekooQdPpEJ9ib4UZtGGjoauTLxPyLmjZw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>杨成进</p></div><div style="margin-top: 5px;text-align: justify;font-size: 12px;"><p style="text-align: center;white-space: normal;">哔哩哔哩高级开发工程师</p></div></div></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 53%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>张建锋</p></div><div style="margin-top: 5px;font-size: 12px;"><p style="text-align: left;">哔哩哔哩高级开发工程师</p></div></div></div></div><div style="display: inline-block;vertical-align: middle;width: 32%;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 28.0985%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy7s5Dibx10xVoKseB7QicxstQoVqetualUIkHwgO8cnwUEUBMMfDac9mw/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img data-imgfileid="100015376" data-ratio="1.2853688029020556" data-s="300,640" data-type="jpeg" data-w="827" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy7s5Dibx10xVoKseB7QicxstQoVqetualUIkHwgO8cnwUEUBMMfDac9mw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div></div></div><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>背景介绍</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">B站的下行CDN旧架构如下图所示，可以看到边缘CDN节点与中心调度服务有紧密协作，简单说是先由调度服务进行流量调度(负责均衡的调度到每个网关组件节点），再由回源组件进行集群内的回源收敛，最终到对应的回源节点进行回源。随着业务体量的增加，这种模式所带来的风险也不断的被暴露出来。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015379" data-ratio="0.8148148148148148" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 360px;height: 293px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy42aj6krias13CCRMDedNWdDOlCTKNXOR76LnlIBHb3Rzf6GPCsIPRRA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">注：同集群指在相同机房；节点指物理机器或者容器</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">这种模式存在以下几种弊端：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">中心调度服务的负载均衡策略与边缘同集群内的回源收敛策之间的协作难度大(回源节点选择不一致、资源冷热判断不一致等等)，导致"事故"频繁</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">边缘节点出故障后，中心调度服务从感知到故障事件，再到流量切走，再到长尾流量干涸，这一过程起码需要20分钟，遇到直播业务那就更惨</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">资源(cpu、缓存)利用率不符合预期，存在毛刺多、不均衡和回源率高等问题，频繁触发SLO告警</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">治理/提升用户播放体验的开发难度大且复杂性高，比如资源预热，需要提前知道直播流会分配到哪几个网关节点上等等</p><p style="word-break: break-all;margin-bottom: 15px;"><br></p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">根据以上几个点以及点/直播业务特性，我们提出了几个最基本的要求，以满足日益增长的流量和对播放质量的追求</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">网关组件必须具备流量分流能力，具备7层负载均衡加4层负载均衡能力</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">一套集群内组件服务状态检查机制，做到及时发现过载组件进行扩容以及能敏感发现故障组件进行踢出</p></li><li><p style="word-break: break-all;">所有策略功能都收敛到中控组件来完成，避免同个资源在不同节点上出现两种不同流量策略，同时也让原有的其他组件改动最小化(保持单体架构的开发思维，提升开发效率)</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>新架构设计</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015384" data-ratio="0.7444444444444445" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 405px;height: 302px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsySUnqMaszglptgVXmiaORSRGicuWKf1GJafN9nWZqFNTL96LbMqk4mRIA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">网关组件：对外提供用户的访问协议(H1、H2、H3)，具备对访问流量进行鉴权、收敛等功能</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">缓存组件：聚焦磁盘IO技术栈、文件系统以及缓存淘汰策略等</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">回源组件：聚焦回源协议(私有/通用)以及如何提升回源速率等</p><p style="word-break: break-all;white-space: normal;">中控组件：聚焦集群内流量路由策略(热流打散、异常组件踢出等等)以及针对业务的定制化优化策略等</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>网关组件具备流量分流能力</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">部分可以拆分成4层负载均衡和7层负载均衡，其中4层负载均衡是由其他组同学完成的(见：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247497763&amp;idx=1&amp;sn=3f8196457d5893c52b96256eed47d424&amp;chksm=cf2f3d06f858b4105c33f5af5f4d0580ba94b212dc72716c9b218aea3b75c85988d35ce79d2b&amp;scene=21#wechat_redirect" textvalue="B站边缘网络四层负载均衡器的探索与应用" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span style="text-decoration: underline;color: rgb(12, 182, 242);">B站边缘网络四层负载均衡器的探索与应用</span></a>）</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>4层负载均衡</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">主要解决由于调度不均衡导致的节点负载不均衡问题，同时又能及时切走故障的7层节点，提升系统的整体容错性</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015382" data-ratio="1" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 451px;height: 451px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy7Kq24LLw31wNzzKMzIy7A3RICyicBO636WYdicib2TJduibBPyp6NqLDYA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>7层负载均衡</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">主要解决当缓存组件或者回源组件出现问题时，踢掉问题组件并且重试到其他节点(回源依旧会优先回到之前的回源组件节点：图中5-1路线），保障用户的播放体验</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015383" data-ratio="0.8074074074074075" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 458px;height: 370px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyrNx4PlpgI9ITHIF7bwCuYq6xqRGcJ3ZAgedDL4AdcAe0g7tibdw80kA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>中控组件</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">现在流量入口的问题已经解决了，部分节点故障已经影响不到服务质量，接下来我们重点看一下中控组件(中控组件本身是多节点，且保证查询接口是数据一致的)是如何将其他组件节点串起来的</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>负载均衡策略</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">直播和点播的业务场景还是有些区别的，叠合一些历史问题，这次改造将点/直播负载均衡策略拆成两个单独模块实现，后续计划还是会整合到一起</p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>直播负载均衡策略</strong></span></p><p style="word-break: break-all;white-space: normal;">我们将负载能力划分成一个个小长方条，当某个资源(流)占据的条数&gt;=N时，则会触发流量打散策略，将溢出的流量划分给其他组件，如图中“组件-1”内的深绿色大长方条，被平均切割成3个中长方条</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015381" data-ratio="0.3925925925925926" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 521px;height: 205px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyxbwpZEkZQeP5YJx8WmiaSk7oFpCOPVgU2vhDnSpYFEZfteQtNgVlCvg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">接着，我们可以看到网关组件会将每个请求的实时带宽同步到中控，这也是所有策略的数据源。中控组件对数据进行清洗、整合和观测，实时调整网关组件的流量链路，如图中绿色的实线链路</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015385" data-ratio="0.7342592592592593" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 478px;height: 351px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyG0HYdr5rtuia8JtJOoyuiaG7tB7hXPlTcrLMGYe6V1QqKDYzEwz4maQQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>点播负载均衡策略</strong></span></p><p style="word-break: break-all;white-space: normal;">因点播文件大小普遍大于缓存组件的分片大小，所以在网关组件这边根据分片大小进行切分，并用一致性哈希方式进行负载均衡，虽然做法很糙，但也足够用</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015390" data-ratio="0.9074074074074074" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 454px;height: 412px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsycJCvJibunQHmCFH4V9vzvPiaMno11icnHHNdakxr53vLesFB0h4KpgtXg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">这里我们在nginx http slice 模块上进行了改造，原有的http_slice_module存在以下几个问题：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">1）对齐后的offset会导致读放大(存在冗余数据)，原设计是为了缓存，但我们架构有专门的缓存组件，并不需要nginx做缓存</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">&nbsp;2）一定是前面的子请求结束后，才能发起下一轮的子请求，这可能导致非预期的“等待”(假设用户请求被切成N个请求，则需要多等待N-1个http&nbsp;header的结果)</p><p style="word-break: break-all;white-space: normal;">我们的做法是增加预取窗口，在subrequest-2收到http&nbsp;header时，会触发subrequest-3请求的发送，同时控制同一时间只会存在两个subrequest，这样保证nginx内存不会过于膨胀，同时也不会对后端节点造成过大压力</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015389" data-ratio="0.6138888888888889" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 499px;height: 306px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyIwymofd4jZhFS5icwbq3jHMgxUfickBvyLutISKHcvSnxibERibA1XxQZw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">代码如下：</p></div><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">typedef</span> <span class="code-snippet__class"><span class="code-snippet__keyword">struct</span> {</span></span></code><br><code><span class="code-snippet_outer"> ...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">ngx_http_request_t</span>* &nbsp;prefetch[<span class="code-snippet__number">2</span>];</span></code><br><code><span class="code-snippet_outer">} <span class="code-snippet__keyword">ngx_http_slice_ctx_t</span>;</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">ngx_http_slice_body_filter(<span class="code-snippet__keyword">ngx_http_request_t</span> *r, <span class="code-snippet__keyword">ngx_chain_t</span> *in)</span></code><br><code><span class="code-snippet_outer">{</span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx == <span class="code-snippet__literal">NULL</span> || r != r-&gt;main) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__comment">// 确认前面的预取子请求已经完成header处理，可进行下一个分片预取</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx &amp;&amp; ctx-&gt;active) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rc = ngx_http_slice_prefetch(r-&gt;main, ctx);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (rc != NGX_OK) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> rc;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> ngx_http_next_body_filter(r, in);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;rc = ngx_http_next_body_filter(r, in);</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (rc == NGX_ERROR || !ctx-&gt;last) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> rc;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx-&gt;start &gt;= ctx-&gt;end) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ngx_http_set_ctx(r, <span class="code-snippet__literal">NULL</span>, ngx_http_slice_filter_module);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ngx_http_send_special(r, NGX_HTTP_LAST);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> rc;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (r-&gt;buffered) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> rc;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx-&gt;active) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__comment">// 分片预取</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;rc = ngx_http_slice_prefetch(r-&gt;main, ctx);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> rc;</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">ngx_http_slice_prefetch(<span class="code-snippet__keyword">ngx_http_request_t</span>*r,<span class="code-snippet__keyword">ngx_http_slice_ctx_t</span>* ctx)</span></code><br><code><span class="code-snippet_outer">{</span></code><br><code><span class="code-snippet_outer"> &nbsp; <span class="code-snippet__comment">// control prefetch win</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx-&gt;prefetch[<span class="code-snippet__number">1</span>]) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (!ctx-&gt;prefetch[<span class="code-snippet__number">0</span>]-&gt;done) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> NGX_OK;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ctx-&gt;prefetch[<span class="code-snippet__number">0</span>] = ctx-&gt;prefetch[<span class="code-snippet__number">1</span>];</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ctx-&gt;prefetch[<span class="code-snippet__number">1</span>] = <span class="code-snippet__literal">NULL</span>;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ctx-&gt;start &gt;= ctx-&gt;end) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> NGX_OK;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; </span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (ngx_http_subrequest(r, &amp;r-&gt;uri, &amp;r-&gt;args, &amp;ctx-&gt;prefetch[<span class="code-snippet__number">1</span>], ps, NGX_HTTP_SUBREQUEST_CLONE)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;!= NGX_OK) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> NGX_ERROR;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;ngx_http_set_ctx(ctx-&gt;prefetch[<span class="code-snippet__number">1</span>], ctx, ngx_http_slice_filter_module);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;ctx-&gt;active = <span class="code-snippet__number">0</span>;</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__comment">// init once</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (!ctx-&gt;prefetch[<span class="code-snippet__number">0</span>]) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ctx-&gt;prefetch[<span class="code-snippet__number">0</span>] = ctx-&gt;prefetch[<span class="code-snippet__number">1</span>];</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;ctx-&gt;prefetch[<span class="code-snippet__number">1</span>] = <span class="code-snippet__literal">NULL</span>;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">ngx_http_slice_loc_conf_t</span>* slcf = ngx_http_get_module_loc_conf(r, ngx_http_slice_filter_module);</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">off_t</span> cur_end = ctx-&gt;start + get_slice_size(ctx-&gt;start, slcf);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__comment">// 判断对齐后末尾数值如果大于用户请求的末尾数值，则取用户的末位数值，避免读放大</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (slcf-&gt;shrink_to_fit) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;cur_end = ngx_min(ctx-&gt;end, cur_end);</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;gen_range(ctx-&gt;start, cur_end - <span class="code-snippet__number">1</span>, &amp;ctx-&gt;range);</span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">我们做了一个简单的场景模拟，可以看到改造后请求的处理耗时比改造前处理耗时减少了40%，也就能更快响应用户的请求</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015387" data-ratio="0.462037037037037" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyNNX8EzdljECboEU2wicHvmM0Y2vu3vR9rPj6gE0q5Nj43nj2cyLjEQg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015386" data-ratio="0.2796296296296296" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyK3LZQZtZJSJZjvJIskOBj52ef15EFaXGcKNJdSQrIIe3rqbKpt8Fyw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>最终成效</strong></span></p><p style="word-break: break-all;white-space: normal;">在点/直播负载策略共同生效下，可以看到相比之前旧架构有很大的稳定性提升</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015388" data-ratio="0.425" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyboFzTDW3hU3fCz4cUwtbgbdIbp1xCjd7YALXjmgZ1NG3qt7fIn4X8Q/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">我们再看看SLO监控数据，在新架构未全量前，每个周末都会有部分集群触发SLO告警，在新架构逐步扩量后，SLO的抖动也减少了</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015391" data-ratio="0.7101851851851851" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyXdKDbyicdkzRDViaE3KSOeURoeMuCepAiapxnjI44OtY2xXe62qcLFubg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>聊聊新架构如何业务赋能</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>业务混跑</strong></span></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">点播、直播业务对于机器资源要求不同，点播更倾向拥有更多的磁盘来做IO吞吐和存储的横向扩容，而直播更倾向拥有更多的cpu资源来做协议的转封装或数据迁移拷贝。这就出现很微妙的关系，点播场景下可以利用DMA来减少cpu参与磁盘数据拷贝(我有空闲的cpu资源)，而直播场景对于机械硬盘基本不用(我有空闲的磁盘资源)，一拍即合</p><p style="word-break: break-all;white-space: normal;">在点直播混跑情况下，点播回源率得到下降，直播拥有更多cpu资源能跑更多流，不管点播还是直播都能对外提供更好更快的服务，并且我们运营同学再也不需要为节点角色的转换(点播&nbsp;或&nbsp;直播？)而苦恼</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015393" data-ratio="0.40925925925925927" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyT3M5qqGmT4f7ZfD3XwmiaDlzv6ou82BLUBw8pjmo1YmvR9JyfHuCWiaw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015392" data-ratio="0.39537037037037037" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyo3mibSY7PTbLiaX9x61I54YtHQh4h1XiaQLbd0yyIGfAHx1ib1nFXM32yA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>直/点播预热</strong></span></p><p style="word-break: break-all;white-space: normal;">在旧架构模式下，开启预热很费劲，因不知道用户会访问哪个节点，所以只能采用广撒网方式，这种方式效率低不说，还可能空增加组件负担，并且预热任务也只能手动下发(并不知道谁是热的)</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015394" data-ratio="0.6833333333333333" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 466px;height: 318px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyOdYLyVeOceUicmSoUMvWzUNVc2TNeYdJS9Z0oqGbJxUS3cpkm4z1TWA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">新架构模式下，每个集群会选出一个中控组件来实时观测集群热流，发现有热流后会触发预热策略，将预热任务下发到其中的一个网关组件</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015395" data-ratio="0.7722222222222223" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 475px;height: 367px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyD4t8ianpsAGldXTBuqQ32iaKXCLGqjicFnN8oq9LbtgPiauydBk0KCTxdA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>存储资源最大化利用和编排</strong></span></p><p style="word-break: break-all;white-space: normal;">显而易见在旧架构模式下，网关组件只被允许访问本节点的缓存组件，所以只能保证单节点的存储资源是互斥的，并非整个集群的存储资源是互斥的。而新架构下，我们会根据每个缓存节点的存储容量和磁盘IO性能，重新规划了每个节点应被分配到的资源访问，尽可能保证每个缓存节点缓存的资源都是互斥的。再聊细点，我们知道机械硬盘的外圈吞吐量是大于内圈的，那在集群闲时期间，我们是不是可以做一些存储资源的重新编排，比如把热的资源移动到外圈以求获得更稳定的服务质量</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015399" data-ratio="0.387037037037037" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsyC3thFS2I7sJED9F2icV9QvMnyAOz3l6IHicSGiaPxg4KZCeHk1Km6EjPw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>提升服务稳定性还有哪些方案？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月26日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 45%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015398" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754QSzUm8T4w4AmPZkxhG2xsy05Mv95FgBvDibl5P9AeTgJxXXibEtbQOnjak3sG7oQkGQzlE2Hp40vsg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247497452&amp;idx=1&amp;sn=eb51b2ed9f0810d154cd1891845c26f1&amp;chksm=cf2f33c9f858badf692afb57015e3dd0446bf603c7de0e7113354ad81abc9ae9c56f614ed027&amp;scene=21#wechat_redirect" textvalue="云厂商CDN故障后，连夜设计了云边端协同新方案" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">云厂商CDN故障后，连夜设计了云边端协同新方案</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247497385&amp;idx=1&amp;sn=4732d7b5d077fe1afe2660d330e43ba6&amp;chksm=cf2f338cf858ba9ae217c9f3644d2cb7bfda35131f3beaf5bab6dd0287257be9499063cbf0a0&amp;scene=21#wechat_redirect" textvalue="语聊房架构演进实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">语聊房架构演进实践</a></p></li><li><p>会员购交易系统架构演进<span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: var(--articleFontsize);letter-spacing: 0.034em;"></span></p></li></ul></div></div></div></div></div><div style="margin-bottom: 0px;outline: 0px;line-height: 1.6;font-size: 16px;visibility: visible;"><div style="outline: 0px;line-height: 1.6;visibility: visible;"><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="outline: 0px;"><br style="outline: 0px;"></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="233" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p></div></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>B站CDN平台团队</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[重构国内游戏账号登录系统的思考和实践]]></title>
        <id>2247499022_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247499022&amp;idx=1&amp;sn=7e50f0d8349d2dbe0aecfee3442d5f70&amp;chksm=cf2f382bf858b13d6fadb1616cd3d19e482b31a608b09299734e6efdd0e8d62976e1ca0d8173#rd"/>
        <updated>2024-04-18T12:40:01.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;background-position: center center;background-repeat: no-repeat;background-size: cover;overflow: hidden;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFKOdTEPagXFVhnbrCiaqCAD7iafcy0wBgsHNnlepfE8am77HGWic9NnzJQ/640?wx_fmt=png&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015354" data-ratio="1" data-s="300,640" data-type="png" data-w="512" style="width: 100%;height: 100%;opacity: 0;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFKOdTEPagXFVhnbrCiaqCAD7iafcy0wBgsHNnlepfE8am77HGWic9NnzJQ/640?wx_fmt=png&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>丰富</p></div><div style="margin-top: 5px;text-align: justify;font-size: 14px;"><p style="text-align: center;white-space: normal;">哔哩哔哩资深开发工程师</p></div></div></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">账号登录系统，作为游戏发行平台最重要的应用之一，在当前的发行平台的应用架构中，主要承载的是用户的账号注册、登录、实名、防沉迷、隐私合规、风控等职责。合规作为企业经营的生命线，同时，账号登录作为在线链路转化的第一站，因此账号登录系统的稳定性，一直面临极高的要求。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">出于稳定性需要，游戏发行平台在很早期就实践了两地三中心的多活架构。目前以公司公司机房为中心，同时在华东公有云和华南公有云，实现了两地三中心部署方案。依托公有云的主要考量因素在于，早期公有云提供的快速弹性和按量付费的能力，能够高效的承接游戏业务方的发展诉求；其次，对于华南地区的选择，也是优先考虑重要合作方所处的地理位置。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">基于稳定性、效率、成本的多方考量，最终实现了公司机房、华东公有云A、华南公有云B的混合云架构。混合云架构带来便利的同时，也存在普遍的挑战，其中最显著在于两个方面：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">其一、数据架构，数据在云端存储的存在的泄露风险。在具体实施层面，数据架构的差异化，将会导致底层的领域服务所能交付的API必定存在差异，主要差异体现在API的能力范围。比如，bilibili授权登录等能力，云上机房是无法做到实际支持的，服务端只能将相关请求转发至公司机房处理。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">其二、PaaS平台的差异。公司基础架构在数据库管理平台、KV数据管理平台、消息队列等产品支撑已相当成熟，但早期在公有云的应用部署只能依托云原生的能力。这导致在底层的依赖上，原本需要建立一个标准防腐层，屏蔽具体的实现差异，但因为业务进度的需要，导致有所折中欠缺。</p><p style="word-break: break-all;white-space: normal;">由于存在以上两个显著的挑战，项目进展等因素的考虑，最终演变的应用架构如下，也因此账号登录系统，在公司机房和公有云机房演变出了两套代码仓库(login-idc-api / login-cloud-api)。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015356" data-ratio="0.4842592592592593" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFO8NyMKiabYARehRlFQny1eWX3XaFkJBOdVgNHa203xS8MB0ibzqD8JeQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">游戏账号登录应用的两套代码，迭代至今已近7年。当前应用，虽然在主观上理解已经迭代趋于稳定，但是基于最近一年完成的迭代版本统计，全年迭代版本超过10次，版本平均耗时接近4周，包括设计、开发、测试、上线。双代码仓库导致的设计、开发、测试，部署平均耗时增加了30%~40%。其次，在双代码仓库，且依赖Spring等核心组件版本较低的情况下，对齐公司基础架构的各项产品，可预见工作量的前提之下，该系统的重构工作，已经到了不得不行的地步。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>挑战</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">为稳定性诉求极高、迭代长久的系统发起重构，需要巨大勇气，得失于转瞬之间。</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">重要性：承载千万MAU，L0不可降级链路；支撑113个SDK版本（采样周期：2024/02/15 - 2024/03/15）</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">稳定性：重构过程中SLO 4个9的约定，必须在执行之前规划完成执行细节和过程，全面又不失细致；</p></li><li><p style="word-break: break-all;">复杂度：业务本身内在的复杂度，7年来的高速发展，积累的大量技术债。</p></li></ol></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>价值</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">1.效率：开发效率提升<span style="color: rgb(255, 102, 149);"><strong>50%，迭代效率提升30%-40%</strong></span></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">2.成本：节省人力（预期当前系统的生命周期至少5年）</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">3.质量：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">代码圈复杂度：降低<span style="color: rgb(255, 102, 149);"><strong>40%</strong></span>;</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">内网调用去SLB依赖，核心链路接口RT 99.9Line 提升31.5%</p></li></ul><p style="word-break: break-all;white-space: normal;">4.文化：践行“极致执行”的价值观。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>实践：如何实现重构？</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>战略方向</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">方案一、放弃现有的两地三中心，账号登录全部统一到公司标准，不依赖云厂商。该方案作为未来的长期方向，完全回公司部署符合公司长期战略规划，难点在于发行平台的应用架构，目前绝大多数服务还是重点依赖公有云，短期内不具备独立完成的可行性。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">方案二、推动主站账号团队，打通公司和公有云的数据架构，实现领域能力的对等，但存在数据安全风险，考虑到项目收益和跨团队的工作成本，并非当前最高ROI的选择。</p><p style="word-break: break-all;white-space: normal;">方案三、将双代码仓库中，有关于数据架构和PaaS的差异，以重构的办法实现兼容，达到最终的代码仓库统一。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>思考过程</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>重构的前提</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">回顾Martin Flower有关重构的著作《重构 改善既有代码的设计》一文中，将”重构“以名词、动词两种方式定义如下：</p></div><p style="white-space: normal;"><br></p><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">重构（名词）：对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。</p><p style="word-break: break-all;white-space: normal;">重构（动词）：使用一系列重构手法，在不改变软件可观察行为的前提下，调整其结构。</p></div></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">这本关于重构的经典，在两种定义方式中，提到了3个关键概念，”调整“、”结构“、”不改变软件可观察行为“。这3个关键词组合起来，约等于行动指南。”不改变软件的可观察行为“作为前提，如何理解可观察行为，Martin并未在技术和业务上做过明确的定义，因此在这个概念的理解上，不免要多一些执行者的个人理解和思考。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">如果把应用架构视为当前的结构，对于“可观察行为”的理解，从以下几个角度尝试去思考：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">1.系统职责，前后端分离的应用架构之下，交付这些职责的API是一类可观察的行为；</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">2.系统依赖项，是一类可观察的行为，包括两个大部分：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">bilibili账号的领域服务、游戏发行的领域服务、第三方服务(比如：极验服务提供商)</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">PaaS基础架构（公司的数据库、KV数据系统、消息队列等等；公有云的云MySQL、Redis、Kafka等等）</p></li></ul><p style="word-break: break-all;white-space: normal;">3.系统的横向服务。从分层架构的层次上来说，当前定位是应用服务层BFF，本不应该出现较大的横向影响，但是过往高速演进的过程中，承载了部分领域服务的职责（比如：查询游戏信息、查询活跃游戏、查询用户信息等），因此姑且对于这一类概括为横向的影响。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>形形色色的差异</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">当前应用架构下，双仓库在逻辑模块、应用内分层（J2EE的3层模型）的特点，展示如图：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015355" data-ratio="0.5861111111111111" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFuiblN2nT0GCdgvCCNicxBfmLXA74TPza4LQN1oqDR8A5S7eAN5TTqjQg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在不可变的前提之下，试图通过对齐双仓库代码差异，以求得统一的思路，单从Service这一层来说（其依赖的bilibili账号服务API超过80个），理解起来已足够让人头大，其变更风险也是极其巨大，更何况还有JDBC ORM、Redis在技术选型和使用约束上的差异。如此风险再加上即将投入较大的工作量，势必提案困难重重。基于静态的模块和应用内代码分层来看，这巨大的差异看似是无法“暴力”抹平。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>消失的复杂度</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">柳暗花明时刻，来源于应用运行时的一个事实：“生产环境多次高可用切流”。这个事实不仅实现了对SDK上游异地多活的承诺，而且经过了生产环境的多次验证。简而言之，双仓库在Controller、Service这两个最业务逻辑最复杂，技术债积累最多的分层，虽各有千秋，但殊途同归。</p><p style="word-break: break-all;white-space: normal;">由此推理，重构过程中的最大的认知注意力负担，可以直接从这两层忽视。这两层注意力的移除，同时也利好DB和Redis的兼容工作量，作为基础架构中最重要的两个组件，完全无需再关注各类RedisTemplate/Jedis，Key命名、JdbcTemplate/Mybatis 、SQL的之间的逻辑差异，因为他们只是Controller和Service最终呈现出来的一部分。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>在混沌中聚焦</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">SDK API链路：由于Controller、Service复杂度的消失，那么剩余的不可变的可观察行为，就只集中在DAO。DAO差异的本质来源于混合云部署架构的挑战（数据架构、PaaS差异），那么实现策略也就清晰了，在DAO层基于运行时ZONE来标识依赖的bilibili账号API调用即可。参考六边形架构，对于外部依赖和业务逻辑的隔离方式，实现核心业务逻辑对于外部API和PaaS解耦，以此降低变更侵入的影响面。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015358" data-ratio="0.47685185185185186" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFz3D80mRb2Qjl9lF5c9dplf1f9ibe4Xn76RgRZgY1B00hZnC7bD0DNlg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">PaaS的差异在业务逻辑层Service（或者少量的Controller）已经被消化，因此无需再考虑逻辑上的差异，只需关注框架和数据库的版本兼容性。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">领域类和通知类API链路：这条链路虽然不是核心，但这是混合云数据架构差异的体现。生产环境的调用集中在公司机房，能力”较小“的公有云应用，向公司应用融合靠拢，也正因如此，统一之后的代码仓库是以公司机房代码仓为基准。</p><p style="word-break: break-all;white-space: normal;">转发类API链路：这条链路差异化的本质也是来源于混合云部署的数据架构差异，在当前的融合方案中无法解决，因此只能沿用现有的转发策略，但转发后续可向上移交至API GW实现，这个已在计划当中。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>具体实现</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015357" data-ratio="0.4148148148148148" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtF2jFhsxYhO6vSSyOqg3CU1blwueo6UL3uHE6Hc7SoOT8NiaG9hMnlRsw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">公司机房原仓库为基准，在公有云A/B可用区部署，可用区选择与当前两地三中心保持一致。依赖的DB Schema在三机房原本就相同，因此可直接复用已有的DB实例。Redis，因其均有读写操作，避免灰度过程对于线上应用的数据污染，因此部署单独的Redis集群用于数据隔离，待完成灰度之后，一并下线原应用和原Redis集群。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>数据验证</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>产品视角</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">基于用户维度，验证比对新老集群的数据写入和查询；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">基于游戏维度，验证比对新老集群的数据写入和查询；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">生产环境SDK，基于测试域名，实现核心SDK产品回归验证，覆盖全量用例；</p></li><li><p style="word-break: break-all;">其他非SDK API，实现全量的单测覆盖，基于接口实现验收。</p></li></ol></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>数据视角</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">数据库：基于Job任务，实现源与目标数据源内容比对；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">缓存：纯缓存场景，灰度期间隔离部署，回滚后不影响业务逻辑。缓存未命中直接远程调用；</p></li><li><p style="word-break: break-all;">埋点/报表：基于灰度过程观察游戏维度的报表趋势，并与过往数据进行比对。</p></li></ol></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>发布方案</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">发布计划设计，严格遵守公司安全生产要求：可灰度、可观测、可恢复。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>可灰度</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">灰度过程一共分为两个大步：</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>Step1</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在公司机房执行灰度部署，分批部署导入生产流量，发现异常立即回滚。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>Step2</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在公有云A执行全量发布，但未接流；通过SLB规则配置，基于域名、规则的重要性、API的量级（调用量/周）制定规则级的SLB发布计划。公有云B部署同样重复此步骤。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>可观测</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">观测的主要维度：业务和SLO、日志、性能</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>观测1：原公有云A应用流量切流后分布和成功率</strong></p></div></div></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015362" data-ratio="0.48518518518518516" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtF728NWEibLVsIMrwJib2lmF2zjo4yBuNXGCS9nAe66Scz6chKRvjg3DwQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>观测2：新公有云A应用流量切流后分布和成功率</strong></p></div></div></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015361" data-ratio="0.4861111111111111" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFIbyIqdR4Vv2JKsvYibTs3Yrd9ib6VKF2ayC6FjB68KFBcYCLshbHVRWA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>观测3：新公有云A应用错误码分布</strong></p></div></div></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015360" data-ratio="1.598984771573604" data-s="300,640" data-type="png" data-w="788" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtF40ibicljb7uPcHJFoKLyxJYnjRyq3U8yfTibV5aQiceUckFoE5o1nXxODw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>观测4：新公有云A应用API性能</strong></p></div></div></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015363" data-ratio="0.7824074074074074" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFfL5uOnr0IPjdEIS1BlQgFPnia1hpR1DE8jytd8iaXW15kKhmVewta47w/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>观测5：新公有云A应用JVM性能</strong></p></div></div></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015359" data-ratio="0.5055555555555555" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFMZIeX7RSmeRuWibY5ibaW3dKvPxbpAE4hRvSAKLQQiaoKAAqa3T46TfQw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>可恢复</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">1.公司机房应用执行灰度部署，如遇异常立即回滚，且不产生脏数据</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">2.新的公有云A/B应用，通过SLB基于规则分批发布，如遇异常立即回滚，回滚后流量指向原有对应机房服务集群，Redis写产生的脏数据不影响回滚后业务逻辑</p><p style="word-break: break-all;white-space: normal;">3.新的公有云可用区，申请单独的Redis实例，用于隔离不同代码仓库，不同Key命名风格的数据，避免回滚过程中脏数据，对于原可用区服务的影响。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>参考资料</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">《B站安全生产专项建设实践》&nbsp;<span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://mp.weixin.qq.com/s/tj1PEUWAyRZ1QzeW_oCWfg</em></span></p></li><li><p style="word-break: break-all;margin-bottom: 15px;">《重构 改善既有代码的设计》Martin Flower</p></li><li><p style="word-break: break-all;">《Complexity Has to Live Somewhere》<span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://ferd.ca/complexity-has-to-live-somewhere.html</em></span></p></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>关于重构，您还有哪些有趣的实践？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月23日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 40%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015365" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" width="100%" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RMOfyxumMmH0TZczHQkNtFxIY3YLkqdLuoxS78dONkjYCUia6BM9ensPia2kIcIZvKHNdVbSG1jkibA/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;">游戏全球发行平台的实践与探索</p></li><li><p style="margin-bottom: 15px;">游戏全球发行提效-- 发行 iOS SDK的自动化接入探索</p></li><li><p>多容器动态化方案在游戏SDK中的实</p></li></ul></div></div></div></div><p><br></p><div style="margin-bottom: 0px;outline: 0px;line-height: 1.6;font-size: 16px;visibility: visible;"><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="outline: 0px;"><br style="outline: 0px;"></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="232" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p></div></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>丰富</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Matroska解封装原理与实践]]></title>
        <id>2247498988_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498988&amp;idx=1&amp;sn=16befcac3d32504553b1c1b59582cea8&amp;chksm=cf2f39c9f858b0dfd72e7486169ec7dbd3e80736386e79a40c468b4114d58b78514a187e171b#rd"/>
        <updated>2024-04-16T03:49:23.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 100% 50%;background-repeat: no-repeat;background-size: 125%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLialqqtDK1SD9vH8Zl9KoXhbIykgK2TlqGjQwOwgAwMicvSkfpWDPCsjUA/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015308" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLialqqtDK1SD9vH8Zl9KoXhbIykgK2TlqGjQwOwgAwMicvSkfpWDPCsjUA/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>王妍君</p></div><div style="margin-top: 5px;text-align: justify;font-size: 14px;"><p style="text-align: center;white-space: normal;">哔哩哔哩高级开发工程师</p></div></div></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Matroska是一种开放标准、功能强大的多媒体封装格式，可容纳多种不同类型的视频、音频及字幕流，其常见的文件扩展名为.mkv、.mka等。与应用广泛的MP4相比，Matroska更加灵活开放，可以同时容纳多个字幕，甚至可以包含章节、标签等信息，成为了许多用户的偏爱。B站Web投稿页上传的所有视频中，封装格式为Matroska的视频占比超过2%，是除MP4以外占比最高的格式。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Web投稿页作为稿件生产的第一个环节，在获取到用户上传的视频后会根据视频内容为用户投稿提供辅助，其中包含：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">获取视频元信息，为快速转码提供预分析，缩短转码等待时间，同时为页面其他功能提供视频的基本数据。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">获取视频抽帧画面，对视频画面进行计算，根据计算结果进行AI智能推荐及自动填写，如封面推荐、分区推荐等，为用户填写稿件信息提供辅助。</p></li></ul><p style="word-break: break-all;white-space: normal;">而这些内容的实现，都基于对视频文件的解析，其中又包含了解封装和解码两个部分。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>通用方案</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">此前，Web投稿页的实现方案为使用Emscripten将FFmpeg编译为WebAssembly后在Web平台运行，借助FFmpeg的音视频处理能力来进行解封装和解码。这种方案的优点是支持的视频格式齐全，可以解析几乎所有视频格式，但其缺点也很明确——解析速度慢，无法使用硬件加速，性能不佳，内存消耗大，甚至可能导致页面崩溃。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015310" data-ratio="0.2537037037037037" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLia5iaic1DzF8jeSJNwxiawVyAYJz0oeV1EzsRrWPZSia1hsWLnkuqfrN33NQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>升级方案</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">针对MP4格式视频的解析，Web投稿页已经实现了方案升级，改为使用mp4box（<span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://www.npmjs.com/package/mp4box</em></span>）进行解封装，然后结合WebCodecs API进行解码，方案升级后获取视频信息和视频画面效率提高了70%。Matroska格式是除MP4以外占比最高的格式，在Web投稿始终占据着一席之地，对其解析方案进行改造升级势在必行。使用WebCodecs API进行解码实现起来并不复杂，已有诸多成熟的实践，需要着重解决的问题就是如何对Matroska视频进行高效解封装。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015309" data-ratio="0.24074074074074073" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaic1dDD5ZlfV70qBzFv86ib1nKQNF7b4Lib0dggthYlxlnbUibKoJpMyficA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>技术调研</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>Matroska简介</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Matroska是一种多媒体封装格式，是EBML在多媒体领域的应用。EBML是一种八位位组对齐的二进制格式，由一系列Elements（元素）组成，各个Element可顺序排列，可层层嵌套，能够灵活地表示和存储各种数据。而EBML中的所存储的具体数据内容，随着EBML文件类型的不同而不同，由文件类型所定义的EBML Schema来确定（详见附录1）。Matroska继承了EBML的层级化结构，在EBML基础上定义了一套独特的Schema模式，以实现其强大的功能和特性（详见附录2）。</p><p style="word-break: break-all;white-space: normal;">从宏观结构上看，Matroska文件仅由两个主要的Element组成：EBML Header和 Segment，而Segment中又存储着8个可能的Element，称为Top Element。其中， SeekHead对Matroska解析非常重要，其内部包含了其他Top Element的位置索引，可用于方便快速搜索需要的信息：比如从Info、Tracks中获取视频的元信息，从Cues、Cluster获取具体的视频数据（详见附录3）。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015311" data-ratio="1.3819444444444444" data-s="300,640" data-type="png" data-w="720" style="vertical-align: middle;width: 331px;height: 457px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiasySiaoIzAyGGaiaMX7qaEJh0T60yeiczGre7F9te790qyO9LB8G0icHnMw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">从微观组成上看，无论是EBML Header、Segment还是SeekHead等等，Matroska中的每个Element都是标准的EBML Element，有着确定的解析方式。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015307" data-ratio="1.1396825396825396" data-s="300,640" data-type="png" data-w="630" style="vertical-align: middle;width: 310px;height: 353px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaUfYjntmlmLK76mRIdl6g3m4GicBTeSJ1M7kG3zu0sZ7WibybWIth2LDw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">由此，遵循Matroska特定的EBML Schema结构，按照EBML Element的组成和编码方式进行逐个解析，即可对整个Matroska文件的内容进行读取。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>&nbsp;相关开源项目</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">在MDN文档的WebCodecs API部分可以看到，文档中提及了一些对视频进行解封装的开源项目，对于MP4格式的文件，可以使用mp4box来进行解封装，对于WebM文件，则可以使用jswebm（<span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://www.npmjs.com/package/jswebm</em></span>）。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015316" data-ratio="0.2175925925925926" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaLIk4Mx112nFmokpozCoHR3vBk6iapQkibrhx9lYChCz8MKEiczBEIxb6Q/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">WebM是一种基于Matroska的多媒体封装格式，其规范与Matroska规范基本一致，只是对视频编码和音频编码作出了一些限制（见附录4）。jswebm在解析过程中对文件的音视频编码进行了判定，如果不符合则抛出错误。如果将这部分判定功能进行忽略，jswebm是可以同时解析Matroska、WebM文件的。</p><p style="word-break: break-all;white-space: normal;">jswebm使用起来非常简单，相关代码如下：</p></div><p style="white-space: normal;"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> demuxer = <span class="code-snippet__keyword">new</span> JsWebm();</span></code><br><code><span class="code-snippet_outer">demuxer.queueData(buffer);</span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">while</span> (!demuxer.eof) {</span></code><br><code><span class="code-snippet_outer"> &nbsp;demuxer.demux();</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer">console.<span class="code-snippet__built_in">log</span>(demuxer);</span></code><br><code><span class="code-snippet_outer">console.<span class="code-snippet__built_in">log</span>(`total video packets : ${demuxer.videoPackets.length}`);</span></code><br><code><span class="code-snippet_outer">console.<span class="code-snippet__built_in">log</span>(`total audio packets : ${demuxer.audioPackets.length}`);</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">而细读源码，可以发现其工作方式非常简单明了，就是顺序暴力读取：</p><p style="word-break: break-all;white-space: normal;">1.文件读取层面：</p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015312" data-ratio="0.2647058823529412" data-s="300,640" data-type="png" data-w="816" style="vertical-align: middle;width: 509px;height: 135px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaTwn6e6LqCDw67bLjT0YY1KTKroUSxhZpUW6nAwlGV65uSW3NeX2Fmw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">将整个文件的ArrayBuffer传入，SDK支持将文件一次性完整传入，也可进行切片顺序传入，按照传入的方式将文件内容按顺序存储在列表中；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">对存好的ArrayBuffer列表从头分片读取，分片大小和数量与传入时一致；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">内容解析过程中如果当前分片已用尽，则继续读取下一个分片，直到完成整个文件的解析。</p></li></ul><p style="word-break: break-all;white-space: normal;">2.内容解析层面：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015314" data-ratio="0.9611111111111111" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 387px;height: 372px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaibmSr3x8Rdbh50xgb0tOK0N1pYxmjMcnic2R52pdqU8NAZ3JenSL3AHA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">首先读取EBML&nbsp;Header中的内容，然后获取到Segment部分，按照各个Top&nbsp;Element在Segment部分中的实际存储顺序，用递归的方式顺序解析</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">根据Element&nbsp;Id的不同，对各个Element&nbsp;Data采用不同的解析方式，并对解析结果进行存储</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">初步使用下来，从功能上来讲，我们想要的信息jswebm最终的确都能获取到，但想要在生产环境进行使用，有几个关键的问题不可忽略：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">jswebm的文件读取方式决定了它内存占用极大，相当于整个视频文件都要读取到内存中，且浏览器对转换为ArrayBuffer的文件大小有限制，对于较大的视频文件，转换会直接失败</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">只能对整个文件进行完整解析，而实际使用时并不需要整个文件的完整信息，效率低</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">API不完善，没有提供诸如获取视频元信息、获取某个时间点的视频帧数据等常用方法，需要根据解析后吐出的结果来进行二次复杂运算</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">错误处理比较粗糙，视频文件有异常时解析过程无法正常抛出错误</p></li></ul><p style="word-break: break-all;white-space: normal;">因此，直接使用jswebm来对视频进行解析并不可行，无法满足Web投稿的实际需要。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>方案实现</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>方案设计</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Web投稿页对视频的解析需要在较短的时间内完成，这样才能确保计算结果能够及时曝光给用户，能够给用户投稿提供有效的帮助。这个过程中，内存的占用是非常重要的指标，如果内存占用过大，引发页面崩溃，则会打断投稿流程。实际生产环境使用时，有以下诉求：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">内存占用不能过大，需要进行有效控制，不能随着视频文件大小的增大而线性增大</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">提高解析效率，缩短解析时间</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">提供API单独获取视频元信息</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">提供API获取某个时间点的视频帧数据，后续可结合WebCodecs API进行解码</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">因此，需要设计更加灵活、更加高效的工作流，打造更高性能、更实用的Matroska解封装SDK。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">针对Web投稿页的实际诉求，主要进行以下设计：</p><p style="word-break: break-all;white-space: normal;">1.数据读取层面：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015313" data-ratio="0.2248062015503876" data-s="300,640" data-type="png" data-w="774" style="vertical-align: middle;width: 487px;height: 109px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLia0tBnLgBQZ67N2cLGibTBVSjX1SjT1rg7kErW94Ac6Nd0U5vFia4hhZIQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">直接传入文件的引用地址，不需要预先转换为ArrayBuffer</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">从头开始读取文件，对当前读取位置进行记录，根据传入的分片大小配置及当前位置，动态获取当前位置的ArrayBuffer分片</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">除了可以从头顺序读取文件外，还允许从给定的文件位置开始读取，记录读取位置并获取分片</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">内容解析过程中如果当前分片已用尽，则更新当前读取位置，重新获取新的分片，直到完成整个文件的解析</p></li></ul><p style="word-break: break-all;white-space: normal;">2.内容解析层面：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015315" data-ratio="0.5703703703703704" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 436px;height: 249px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLia0aQ7nKTuBDLeXyWUiaAjj9NTB38IWzNNecOVqF1zlPLJFP1NQ57WibHQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">读取EBML&nbsp;Header中的内容，获取Segment部分，优先解析Segment中SeekHead的内容，记录各个Top&nbsp;Element在文件中的的实际位置</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">提供API，允许直接获取视频元信息或视频帧数据。根据所调用API的不同，去解析文件的不同部分：</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">如果需要获取视频元信息，则根据SeekHead中记录的位置，直接去解析Tracks和Info部分</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">如果需要获取视频帧数据，则根据SeekHead中记录的位置，直接去解析Cues和Cluster部分</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">根据Element&nbsp;Id的不同，对各个Element&nbsp;Data采用不同的读取方式，并对解析结果进行存储</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">定义解析过程中的通用错误类型，补充异常场景的错误抛出</p></li></ul><p style="word-break: break-all;white-space: normal;">根据Web投稿的实际应用需求，实现三个功能模块，分别进行文件预处理、视频基础信息获取、视频帧数据获取。各个模块之间存在一定的依赖关系，会对前置模块的运行结果进行校验。例如，获取视频基础信息时会使用到文件的索引信息，因此会预先检查文件是否完成了预处理工作。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015321" data-ratio="1.0583333333333333" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 417px;height: 441px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaicGvpdABJox47kAflGck3mPPoyfEZb3ibO5pib9pcY2H65nAoV4NmEWVw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">每个功能模块内部又包含着一些子功能，来对视频文件进行不同的处理和分析：</p><p style="word-break: break-all;white-space: normal;">1、文件预处理</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015322" data-ratio="1.0888888888888888" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 408px;height: 444px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaUKbGLeX0kTfCMj1ZYibqetRgAnOeicIgdY6NHK3KbNZjUQSTynicEgfjQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">文件初始化：用于接收文件，按照传入的参数设置文件读取时的每个分片大小。分片大小可以根据实际需要来进行合理设置，当设置的分片大小过大时，文件分片会占据较大的内存，当设置的分片大小过小时，会频繁触发文件分片的动态获取，对解析耗时产生影响。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">解析文件索引信息：获取文件的Segment元素，优先搜索Segment中的SeekHead元素，对SeekHead中的内容进行解析读取，获取Segment中各个Top Element的索引位置并进行存储。</p></li></ul><p style="word-break: break-all;white-space: normal;">2、视频基础信息获取</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015318" data-ratio="1.6795580110497237" data-s="300,640" data-type="png" data-w="724" style="vertical-align: middle;width: 349px;height: 586px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLia4wWmqDppPNjgXR1LEQVMVnGWMP5IqGswUUgNhTm1kLRNCagGKuoqWA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">获取视频元信息：根据SeekHead中所记录的Tracks和Info的位置，对两者进行解析，获取视频宽、高、视频编码、音频编码等信息。</p></li></ul><p style="word-break: break-all;white-space: normal;">3、视频帧数据获取</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015317" data-ratio="1.0717131474103585" data-s="300,640" data-type="png" data-w="1004" style="vertical-align: middle;width: 359px;height: 385px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaIqYlRwh0HqBB4H9UTlHNPLLrKouUx6zUovq1X0zSEyG3403QrPdCDQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">获取全部视频帧数据：根据SeekHead中所记录的Cues和Cluster的位置，对两者进行解析，获取视频所有帧数据及是否是关键帧等信息。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">获取某时间点视频帧数据：根据SeekHead中所记录的Cues的位置，对其进行解析，计算与所需时间点最接近的关键帧存储位置和时间索引，根据关键帧存储位置对视频帧数据进行解析和输出。</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">新的方案中，SDK的工作方式和代码逻辑改变很大，因此需要另起炉灶，创建新的SDK——mkv-demuxer（<span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://www.npmjs.com/package/mkv-demuxer</em></span>）。</p><p style="word-break: break-all;white-space: normal;">mkv-demuxer重点解决了内存问题，优化了解析过程中的异常处理，并提供了几个有用的API，基本满足了Web投稿页的应用需求。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>使用方式</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">mkv-demuxer的使用非常简单，首先创建一个解封装器实例，将文件进行传入，配置解析时的分片大小，然后根据实际需要调取相应的API即可。</p></div><p style="white-space: normal;"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">import</span> MkvDemuxer from <span class="code-snippet__string">'mkv-demuxer'</span></span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> demuxer = <span class="code-snippet__keyword">new</span> MkvDemuxer()</span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> filePieceSize = <span class="code-snippet__number">1</span> * <span class="code-snippet__number">1024</span> * <span class="code-snippet__number">1024</span></span></code><br><code><span class="code-snippet_outer">await demuxer.initFile(file, filePieceSize)</span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> meta = await demuxer.getMeta()</span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> data = await demuxer.getData()</span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">const</span> frame = await demuxer.seekFrame(<span class="code-snippet__number">10</span>)</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">其中，getMeta可以获取视频文件基本的容器信息以及视频轨道、音频轨道的编码信息，返回的内容的格式为：</p></div><p style="white-space: normal;"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">{</span></code><br><code><span class="code-snippet_outer"> &nbsp;info: {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;duration: <span class="code-snippet__number">10000</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;muxingApp: <span class="code-snippet__string">"Lavf58.47.100"</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp;video: {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;codecID: <span class="code-snippet__string">"V_VP9"</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;width: <span class="code-snippet__number">1280</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;height: <span class="code-snippet__number">720</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp;audio: {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;codecID: <span class="code-snippet__string">"A_OPUS"</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;channels: <span class="code-snippet__number">2</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;rate: <span class="code-snippet__number">48000</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;},</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">getData可以获取到视频轨、音频轨的所有数据packet信息，包含每个packet在文件中的位置、所在时间戳。同时，cues中存储了视频所有关键帧的时间戳和相对位置信息，可与其他信息结合，得到关键帧在文件中具体位置。getData所返回内容的格式为：</p></div><p style="white-space: normal;"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">{</span></code><br><code><span class="code-snippet_outer"> &nbsp;cues: [</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;cueTime: <span class="code-snippet__number">50</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;cueTrackPositions: {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;cueClusterPosition: <span class="code-snippet__number">660</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;cueRelativePosition: <span class="code-snippet__number">2539</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;cueTrack: <span class="code-snippet__number">1</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;],</span></code><br><code><span class="code-snippet_outer"> &nbsp;videoPackets: [</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;end: <span class="code-snippet__number">3311</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;isKeyframe: <span class="code-snippet__literal">true</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;keyframeTimestamp: <span class="code-snippet__number">0.05</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;size: <span class="code-snippet__number">51</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;start: <span class="code-snippet__number">3260</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;timestamp: <span class="code-snippet__number">0.05</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;],</span></code><br><code><span class="code-snippet_outer"> &nbsp;audioPackets: [</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;end: <span class="code-snippet__number">1998</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;size: <span class="code-snippet__number">1273</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;start: <span class="code-snippet__number">725</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;timestamp: <span class="code-snippet__number">0.001</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;},</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp;],</span></code><br><code><span class="code-snippet_outer">};</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">seekFrame可以根据给定的时间戳返回最接近该时间戳的关键帧数据信息，所返回的内容为：</p></div><p style="white-space: normal;"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">{</span></code><br><code><span class="code-snippet_outer"> &nbsp;end: <span class="code-snippet__number">3311</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp;isKeyframe: <span class="code-snippet__literal">true</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp;keyframeTimestamp: <span class="code-snippet__number">0.05</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp;size: <span class="code-snippet__number">51</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp;start: <span class="code-snippet__number">3260</span>,</span></code><br><code><span class="code-snippet_outer"> &nbsp;timestamp: <span class="code-snippet__number">0.05</span>,</span></code><br><code><span class="code-snippet_outer">};</span></code><br></pre></p><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>性能表现</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">对于改造前后两个SDK的性能表现，可以抽取不同的视频进行测试，验证改造效果。经过多次测试和对比，发现改造后内存占用大大减小，不再受到视频本身体积的影响，能够平稳保持在较低水平；解析视频速度大大提高，基本都能在一秒内完成。尤其对于高分辨率、大体积的视频文件，使用两个SDK进行解析时性能表现差异极大，优化效果最为明显。</p><p style="word-break: break-all;white-space: normal;">以一个4K视频为例，其基本信息如下：</p></div><div style="text-align: center;"><p><br></p><table resolved=""><tbody><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;"><strong>属性名</strong></span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;"><strong>值</strong></span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">视频大小</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">1.61G</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">视频编码</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">VP9</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">分辨率</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">3840x2160</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">码率</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">10023&nbsp;kb/s</span></p></td></tr></tbody></table><p><br></p></div><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">对改造前后的内存占用变化及解析视频时间进行记录，可以得到如下结果：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015320" data-ratio="0.3" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 439px;height: 132px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiae7Jck49Fk3oAxwjh7aibWPZustcWfdKwvcDUztbia7d44nqZXghVlf2Q/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015326" data-ratio="0.3037037037037037" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 416px;height: 126px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaA4rIjCicurvOfZViccdWiakNHe0iakL07hgicOP8PjZenydfZk3W9PvCyjQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">改造后内存占用减少了<span style="color: rgb(12, 182, 242);">98.34%</span>，解析视频时间减少<span style="color: rgb(12, 182, 242);">97.21%</span>。改造后的mkv-demuxer性能表现良好，可以在生产环境进行使用。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>Web投稿实际应用</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Web投稿页在获取到用户上传的视频后会分别获取视频元信息和视频抽帧画面，用以计算推荐封面和推荐分区，推荐结果获取的速度对用户体验有着直接的影响。</p><ul class="list-paddingleft-1" style="list-style-type: disc;"><li><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;">推荐封面的获取：从视频中截取至多30张低清截帧画面，对低清图片进行AI打分，基于打分结果排序重新截取10张高清截帧画面，作为推荐封面</p></div></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015323" data-ratio="0.31203703703703706" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaJYV7XKBTO8GcqcWFibaJsHeBkXoWzyrQtKNkb38kZH3Deeg4Wa6NQww/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><ul class="list-paddingleft-1" style="list-style-type: disc;"><li><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">推荐分区的获取：从视频中均匀截取10张截帧画面，对截帧画面进行打包，上传压缩包，等待AI计算，将计算结果作为推荐分区</p></div></li></ul><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015327" data-ratio="0.35462962962962963" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiabUmSdrBvowpjGI8HAqQZWntFCZvrNuYMIVSWtx6jCTIP0XSnu1Nbkg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">将Matroska视频的截帧方案进行升级，使用mkv-demuxer完成解封装，调用WebCodecs API对视频帧数据进行高性能解码，再结合WebGL以更快的速度绘制截帧画面，当用户投递Matroska视频时，获取到推荐封面和推荐分区的速度会变快。当视频无法解析或浏览器不支持WebCodecs API时，则会自动降级为旧方案，因此成功率不会受到影响。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>数据结果</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">将升级方案与通用的FFmpeg+WebAssembly方案进行对比，可以得到如下结果：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">视频画面截帧过程耗时缩短在80%以上，视频分辨率越高效果越明显</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">推荐封面获取总耗时减少2.29s，缩短了<span style="color: rgb(12, 182, 242);">16.93%</span></p></li><li><p style="word-break: break-all;margin-bottom: 15px;">推荐分区获取总耗时减少8.13s，缩短了<span style="color: rgb(12, 182, 242);">21.36%</span></p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">具体数据如下：</p><p style="word-break: break-all;white-space: normal;">推荐封面获取总耗时：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015324" data-ratio="0.6435185185185185" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 436px;height: 280px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLia81OMQyvPbv4M9ubsdu9X8h6QibLdgsLztDhd02DBciclCGSo5C0pHkyQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">推荐分区获取总耗时：</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015325" data-ratio="0.6509259259259259" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 450px;height: 293px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaicxxdtT7bkAoicAqKnVYabeDp3P6OG0tMIttRboSO0XQ7oVnibFFoXPnw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">由于推荐封面总流程和推荐分区获取总流程中除了画面截帧还包含了许多其他步骤，且受限于WebCodecs API的兼容性，实验组用户中很大比例的用户最终使用的还是旧版降级方案，因此与本地进行的截帧性能测试数据相比，耗时减少的效果得到了一定的稀释。但整体来说，新的方案对用户投稿体验的改善是比较可观的，且随着未来WebCodecs在Web平台的逐渐兼容，优化效果会越加明显。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>后续规划</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">基于Web投稿页的实际运作需求以及mkv-demuxer现有的解析能力，可以规划如下优化策略：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">一、针对Web投稿页上的Matroska视频，可以利用mkv-demuxer的解封装能力，优化视频边传边转流程。在这一过程中，mkv-demuxer能够更加快速地获取视频帧数据，并进行逐帧遍历，精确计算视频的比特率、大小等关键数据。将这些信息更早地同步至视频云，可以加速视频转码的整体流程，提升用户体验。</p><p style="word-break: break-all;white-space: normal;">二、进一步提升mkv-demuxer的解析能力，完善对Matroska格式的全面支持。通过增加对Tag、Attachments等内容的解析能力，兼容对EBML Stream的解析，可以更全面地解析Matroska文件，提取更多有用的信息。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>相关资料</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">EBML相关：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">https://datatracker.ietf.org/doc/html/rfc8794</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">https://docs.racket-lang.org/ebml/index.html</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Matroska相关：https://www.matroska.org/index.html</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">WebM相关：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">https://www.webmproject.org/</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">https://cloudinary.com/guides/video-fomats/webm-format-what-you-should-know</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">工具推荐：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">Hex&nbsp;Fiend</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">MKVToolNix</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">项目地址及npm包：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">github仓库：https://github.com/SuperYanjun/mkv-demuxer</p></li><li><p style="word-break: break-all;">npm包：https://www.npmjs.com/package/mkv-demuxer</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>附录</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1. &nbsp; EBML的结构：</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015328" data-ratio="0.6268656716417911" data-s="300,640" data-type="png" data-w="670" style="vertical-align: middle;width: 390px;height: 244px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiaO6d0xJCUMF2r6tETat6l46FrM8ryZVVic9n0ic2umFC1hY2cBxCD4r4g/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">EBML文件仅由两个部分组成：EBML header和 EBML body。EBML必须以EBML header开头，用以声明如文件类型、编写/读取EBML所需版本等重要信息，提供对EBML body处理方式的声明。而EBML body中的内容，随着EBML文件类型的不同而不同，又包含很多其他的EBML Element。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2. &nbsp; Matroska基于EBML的限制：</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Matroska本身是基于EBML的，只是在通用的EBML基础上制定了Matroska独特的EBML Schema，同时做出了一些规定和限制：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">EBML&nbsp;Header中的DocType值必须是matroska，EBMLMaxIDLength必须是4，EBMLMaxSizeLength必须为1～8</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">至少包含一个EBML&nbsp;Document，更复杂的Matroska可包含多个EBML&nbsp;Document，形成EBML&nbsp;Stream</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">每个EBML&nbsp;Document必须以EBML&nbsp;Header开始，随后跟着一个Segment</p></li><li><p style="word-break: break-all;">存在8个可能的顶级Top&nbsp;Element</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3. &nbsp; Matroska的Top Element：</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Matroska不同的Top Element，存储了文件的不同内容：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">SeekHead：包含了其他Top Element的位置索引，由于Matroska对8个Top Element的位置顺序没有进行规定，如果没有位置索引，想要寻找其中某个元素则需要对整个文件进行搜索。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Info：包含了Segment内容的整体信息，如标题、时长等。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Tracks：包含了每个轨道的信息，如轨道类型、分辨率、采样率、编码等。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Chapters：包含了所有章节内容，有了章节划分便可以在视频中进行跳转。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Cluster：包含了每个轨道的具体数据内容，每个Cluster中包含了至少一个SimpleBlock或BlockGroup元素，存储了视频具体的数据信息；每个Cluster都包含一个时间戳，用于表明该Cluster中第一个元素的播放开始时间，这种组织形式有利于对视频数据进行查找和进行错误恢复。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Cues：用于播放时进行时间索引，每个Cues元素都包含至少一个CuePoint元素，用于存储该索引下BlockGroup或SimpleBlock的位置。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Attachments：用于为Matroska文件增加附件，如图片、字体、网页等。</p></li></ul><p style="word-break: break-all;white-space: normal;">Tags：包含了对文件的描述数据和额外信息，如歌手、流派、评论、导演等。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>4. &nbsp; WebM与Matroska的区别：</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">WebM由Google推出，目标是构建一个开放的、免费的视频格式。WebM在互联网中使用非常方便，因为它通常压缩率高，体积较小，使得共享和传输媒体内容变得更加容易，也节省了存储空间。WebM是基于Matroska多媒体容器格式进行开发的，所不同的是，WebM对视频编码和音频编码作出了一定限制，并且定义了新的DocType的值：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">视频编码必须是VP8或VP9</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">音频编码必须是Vorbis或Opus</p></li><li><p style="word-break: break-all;">EBML&nbsp;Header中的DocType必须是webm</p></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>你认为前端页面可以结合音视频解析做哪些有趣的事呢？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月19日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 45%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015330" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754ReCW3r56xNM9eKqCUeOqLiagRAl1TUk3BudwFDtA3UQlNevXROibPNoz7MhibFD41hVPZwa9VaWvYRw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498279&amp;idx=1&amp;sn=6b537b59cfb7b03777946de43c50689b&amp;chksm=cf2f3f02f858b614fae703d2fd19e166e87b04af9ac6f48b13d8a333dd34f5da0ce09bfb6770&amp;scene=21#wechat_redirect" textvalue="基于WebCodecs的网页端高性能视频截帧" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">基于WebCodecs的网页端高性能视频截帧</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498175&amp;idx=1&amp;sn=c00bc752a72595fc8d52174301116626&amp;chksm=cf2f3c9af858b58c9d7902bfca13d5940fa5e5cd5565b2c9f91c93c4296859eda9464a34b521&amp;scene=21#wechat_redirect" textvalue="WebCodecs 开启 Web 音视频新篇章" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">WebCodecs 开启 Web 音视频新篇章</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494996&amp;idx=1&amp;sn=c776c04a6d4d2692584b5f745448066d&amp;chksm=cf2f2871f858a167935e11950a7d85d249c55c9c2de2c00c392ade975d5961e4737ce8319201&amp;scene=21#wechat_redirect" textvalue="Web 端实时防挡脸弹幕（基于机器学习）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Web 端实时防挡脸弹幕（基于机器学习）</a></p></li></ul></div></div></div></div><p style="white-space: normal;"><br></p><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><span style="outline: 0px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: var(--articleFontsize);letter-spacing: 0.034em;text-align: justify;"></span><br style="outline: 0px;"></p><p><br></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="231" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>王妍君</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[千万长连消息系统]]></title>
        <id>2247498952_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498952&amp;idx=1&amp;sn=61316837cd685e4d20cf6931858c31a9&amp;chksm=cf2f39edf858b0fb5b60c44a291684541af59dbf612354fcdd72c94633904f417f2256a21197#rd"/>
        <updated>2024-04-11T13:13:48.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;background-position: 54.9618% 41.7178%;background-repeat: no-repeat;background-size: 202.344%;overflow: hidden;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VsfotSXY4GwWdL22zkVTbAZlVncxiaXIx1cl2AU1QhF2JLOdQXmXWqTQ/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015286" data-ratio="1.3333333333333333" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VsfotSXY4GwWdL22zkVTbAZlVncxiaXIx1cl2AU1QhF2JLOdQXmXWqTQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>黄山成</p></div><div style="margin-top: 5px;text-align: justify;font-size: 14px;"><p style="text-align: center;white-space: normal;">哔哩哔哩资深开发工程师</p></div></div></div></div></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>引言</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在当今数字娱乐时代，弹幕已经成为直播平台上不可或缺的互动元素之一。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><br></p><p style="text-align: center;"><img class="rich_pages wxw-img js_insertlocalimg" data-imgfileid="100015301" data-ratio="2.1675925925925927" data-s="300,640" data-type="png" data-w="1080" style="width: 246px;height: 533px;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4Vh89yjDmhvia2P2tuPNmTUG2Q5tvQXOO7OqWen34cRicInOhUhJibQFuvg/640?wx_fmt=png&amp;from=appmsg"></p><p style="text-align: center;"><br></p></div><div style="margin: 10px 0%;text-align: center;justify-content: flex-start;display: flex;flex-flow: row nowrap;"><div style="display: inline-block;vertical-align: middle;width: 50%;padding-right: 5px;align-self: center;flex: 0 0 auto;"><div style="text-align: center;margin-right: 0%;margin-left: 0%;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><br></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">用户通过发送弹幕、送礼等，可以实时在直播画面上展现自己的想法、评论和互动内容，从而丰富了用户观看体验。实时向终端推送互动信息，就需要用到长连接。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连接，顾名思义，是应用存活期间和服务端一直保持的网络数据通道，能够支持全双工上下行数据传输。其和请求响应模式的短连接服务最大的差异，在于它可以提供服务端主动给用户实时推送数据的能力。</p><p style="word-break: break-all;white-space: normal;">本文将介绍基于golang实现的长连接服务，介绍长连接服务的框架设计，以及针对稳定性与高吞吐做的相关优化。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>框架设计</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连接服务是多业务方共同使用一条长连接。因为在设计时，需要考虑到不同业务方、不同业务场景对长连接服务的诉求，同时，也要考虑长连接服务的边界，避免介入业务逻辑，影响后续长连接服务的迭代和发展。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连接服务主要分为三个方面：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">长连接建立、维护、管理。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">下行数据推送。</p></li><li><p style="word-break: break-all;">上行数据转发（目前只有心跳，还没实际业务场景需求）。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1.整体架构</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015285" data-ratio="0.9524564183835182" data-s="300,640" data-type="png" data-w="631" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SOmlNrzbtM3RFwzpfnx3LWMbHcdoMspBIOKvSZQRRNdoUzP4prWLaLFT7SaqdpXEHDbHEORQ1qXw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连接服务整体构架如上图所示，整体服务包含：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">控制层：建连的前置调用，主要做接入合法性校验、身份校验和路由管控。主要职责：</p></li></ul><ul class="list-paddingleft-1" style="list-style-type: circle;margin-left: 32px;margin-right: 32px;"><li><p style="word-break: break-all;margin-bottom: 15px;">用户身份鉴权。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">加密组装数据，生成合法token。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">动态调度分配接入节点。</p></li></ul><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">接入层：长连接核心服务，主要做卸载证书、协议对接和长连接维护。主要职责：</p></li></ul><ul class="list-paddingleft-1" style="list-style-type: circle;margin-left: 32px;margin-right: 32px;"><li><p style="word-break: break-all;margin-bottom: 15px;">卸载证书和协议。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">负责和客户端建立并维护连接，管理连接id和roomid的映射关系。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">处理上下行消息。</p></li></ul><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">逻辑层：简化接入层，主要做长连的业务功能。主要职责：</p></li></ul><ul class="list-paddingleft-1" style="list-style-type: circle;margin-left: 32px;margin-right: 32px;"><li><p style="word-break: break-all;margin-bottom: 15px;">在线人数上报记录。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">记录连接ID各属性和各节点的映射关系。</p></li></ul><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">消息分发层：消息推送到接入层。主要职责：</p></li></ul><ul class="list-paddingleft-1" style="list-style-type: circle;margin-left: 32px;margin-right: 32px;"><li><p style="word-break: break-all;margin-bottom: 15px;">消息封装、压缩和聚合推送给相应的边缘节点。</p></li></ul><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">服务层：业务服务对接层，提供下行消息推送入口。主要职责：</p></li></ul><ul class="list-paddingleft-1" style="list-style-type: circle;margin-left: 32px;margin-right: 32px;"><li><p style="word-break: break-all;margin-bottom: 15px;">管控业务推送权限。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">消息检测和重组装。</p></li><li><p style="word-break: break-all;">消息按一定策略限流，保护自身系统。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.核心流程</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015287" data-ratio="0.5581171950048031" data-s="300,640" data-type="png" data-w="1041" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VT5jykDWJRU2nMI96v7c7aibBD918hI7LnSSMicmfEicR7cvhV1H6FY3mQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连接主要是3个核心流程：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">建立连接：由客户端发起，先通过控制层，获取该设备合法的token和接入点配置。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">维持连接：主要是客户端定时发起心跳，来保证长连接活跃。</p></li><li><p style="word-break: break-all;">下行推送：下行推送由业务Server发起，经由服务层根据相关标识确定连接标识和接入节点，经过消息分发层，把推送到对应的接入层，写入到指定连接上，然后下发到客户端。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.功能列表</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">结合B站业务场景，下行数据推送，提供如下通用功能：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">用户级消息：指定推送给某些用户。比如给某个主播发送邀请pk消息。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">设备级消息：制定推送给某些设备。比如针对未登陆的设备，推送客户端日志上报指令。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">房间级消息：给某房间内的连接推送消息。比如给直播间的所有在线用户推送弹幕消息。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">分区消息：给某分区的房间推送消息。比如给某个分区下，所有开播的房间，推送某个营收活动。</p></li><li><p style="word-break: break-all;">全区消息：给全平台用户推送消息。比如给全部在线用户推送活动通知。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>高吞吐</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">随着业务发展壮大，在线用户越来越多，长连系统的压力越来越大，尤其是热门赛事直播，比如s赛期间，全平台在线人数快达到千万，消息吞吐量有上亿，长连系统消息分发平均延迟耗时在1s左右，消息到达率达到99%，下面具体分析下长连做了哪些措施。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1.网络协议</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">选择合适的网络协议对于长连接系统的性能至关重要。TCP协议可以提供可靠的连接和数据传输，适用于对数据可靠性要求较高的场景；UDP协议是一个不可靠的协议，但是传输效率高，适用于对数据可靠性要求不高的场景；而WebSocket协议也是实现双向通信而不增加太多的开销，更多的用于web端。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">接入层拆分成协议模块和连接模块。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">协议模块：和具体的通讯层协议交互，封装不同通讯协议的接口和逻辑差异。同时给连接模块提供统一的数据接口，包括连接建立、数据读取、写入等。后续增加新协议，只要在协议模块做适配，不影响其他模块的长连业务逻辑。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">连接模块：维护长连接业务连接状态，支持请求上行、下行等业务逻辑，维护连接各属性，以及和房间id的绑定关系。&nbsp;</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">优势在于：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">业务逻辑和通讯协议做了隔离，方便迭代增加通讯协议，简化兼容多通讯协议的实现难度。<br></p></li><li><p style="word-break: break-all;">控制层可以根据客户端的实际情况，下发更优的通讯协议。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.负载均衡</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">采用负载均衡技术可以将请求分发到不同的服务器节点上处理，避免了单一节点的负载过高，提高了系统的扩展性和稳定性。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连增加控制层，做负载均衡。控制层提供http短连接口，基于客户端和各边缘节点实际情况，根据就近原则，动态选择合适的接入节点。</p><p style="word-break: break-all;white-space: normal;">接入层支持水平扩展，控制层可以实时增加、减少分配节点。在S赛期间，在线人数快到达千万时，平衡调度各接入节点，保障了各节点的CPU和内存都在稳定的范围内。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.消息队列</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">消息推送链路是，业务发送推送，经过服务层推到边缘节点，然后下发给客户端。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">服务层实时分发到各边缘节点，如果是房间类型消息，需要推到多个边缘节点，服务层同时还要处理业务逻辑，很影响消息的吞吐量。</p><p style="word-break: break-all;white-space: normal;">所以增加消息队列和消息分发层，消息分发层维护各边缘节点信息和推送消息，提高了系统的并发处理能力和稳定性，避免了因消息推送阻塞而导致的性能问题。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>4.消息聚合</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">当有热门赛事时，同时在线可能达到千万级别，一条弹幕消息就要扩散到千万个终端，假如在线的每个人每秒发一条，需要发送消息量就是1kw*1kw，消息量非常大，此时消息分发层和接入层，压力都会很大。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">分析发现，这些消息都是同一个房间的，属于热点房间，比如s赛房间，观众数量是无法减少的，那只能在消息数上做文章。业务消息推送不能减少，又要减少扩散的消息数，就想到了消息聚合。</p><p style="word-break: break-all;white-space: normal;">针对房间消息，按照一定的规则进行消息聚合，批量推送。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015295" data-ratio="0.41225626740947074" data-s="300,640" data-type="png" data-w="718" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VVGOo0udRDDVnkmCqsBC93ITx7Dr9B9BMbtasz4bc0vdpHkCbQv966A/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">消息聚合上线后，消息分发层对接入层调用QPS下降60%左右，极大的降低了接入层和消息分发层的压力。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>5.压缩算法</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">消息聚合后，降低了消息的数量，但是增加了消息体的大小，影响了写入IO，需要减少消息体大小，就想到了消息压缩。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">压缩算法，选了市面上比较常用的两个：zlib和brotli，进行比较。</p><p style="word-break: break-all;white-space: normal;">抓取了线上业务推送的数据，选择最高等级的压缩等级，进过压缩验证：</p></div><div><p style="white-space: normal;"><br></p><table resolved=""><colgroup><col><col><col><col><col><col><col></colgroup><tbody><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">场景</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">原始大小</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">zlib压缩后大小</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">zlib压缩率</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">brotli压缩后大小</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">brotli压缩率</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;background-color: rgb(255, 255, 255);"><p><strong><span style="font-size: 14px;">brotli相对zlib节省</span></strong></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">2条</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">1126</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">468</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">42%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">390</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">35%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">17%</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">10条</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">4706</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">1728</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">37%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">1423</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">30%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">18%</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">20条</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">9505</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">2674</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">28%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">2172</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">23%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">19%</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">40条</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">19387</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">3161</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">16%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">2488</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">13%</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><span style="font-size: 14px;">20%</span></p></td></tr></tbody></table><p style="margin-top: 10px;margin-bottom: 0px;color: rgb(23, 43, 77);font-family: -apple-system, &quot;system-ui&quot;, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, &quot;Fira Sans&quot;, &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif;font-size: 14px;letter-spacing: normal;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p></div><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">由此可见，brotli相比zlib有很大的优势，最后选择了brotli压缩算法。</p><p style="word-break: break-all;white-space: normal;">选择在消息分发层进行消息压缩，避免在各接入节点多次重复压缩，浪费性能。上线后提升吞吐量的同时，也降低的宽带使用成本。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>服务保障</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">现在有些业务是强依赖长连推送消息，消息丢失，轻则影响用户体验，重则阻塞业务后续流程，进而影响业务流水。针对长连服务消息保障，做了如下工作。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1.多活部署</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">多活部署，通过在不同地理位置部署相同的系统架构和服务，实现了系统在单一地域故障时的快速故障转移，从而提高了系统的稳定性和可用性。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="500" data-cropsely1="0" data-cropsely2="397" data-imgfileid="100015293" data-ratio="0.794" data-s="300,640" data-type="png" data-w="500" style="vertical-align: middle;width: 500px;height: 397px;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VUQIZFDRZZciaG4Ytpiaa0e2EasHsT8cZ5sjJcyHHZQX3PKlWO1L2Hiamg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">长连服务部署，主要做了以下几点：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">长连接在国内华东、华南、华北地域均部署了接入点，支持三大运营商；华南和华中自建机房也部署了接入点；为支持海外用户，增加了新加坡机房独立接入点。<br></p></li><li><p style="word-break: break-all;margin-bottom: 15px;">针对业务场景不同，在云上节点和自建节点之间，实时切换，因为云上节点和自建机房的成本是不一样的，在保证服务质量的前提下，尽可能的控制成本。<br></p></li></ul><p style="word-break: break-all;white-space: normal;">目前线上运行过程中，偶尔会遇到单节点或机房的网络抖动，通过控制层，对有问题的节点，进行秒级摘流，大大减少了对业务的影响。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.高低消息通道</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">多业务消息接入长连接，但不同消息之间的重要性是不一样的，比如弹幕消息和邀请pk消息，丢失几条弹幕对用户体验不会影响很大，但如果邀请pk消息丢失，则会导致pk业务无法进行后续的流程。</p><p style="word-break: break-all;white-space: normal;">针对不同等级的消息，采用了高低优消息通道。重要消息走高优通道，普通消息走低优通道。这样重要和普通消息进行了物理隔离，消息分发优先保证重要消息。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015294" data-ratio="0.2537142857142857" data-s="300,640" data-type="png" data-w="875" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VPT8J943XoufadXjZ2kMacrNiaqcdx6jE959RG59aqeUPfnNmbj5SCpg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">针对高优通道，做了双投递的保障，在接入层做幂等去重。首先重要消息是针对用户级别的，量不会很大，所以对接入层的压力不会增加很大。另外双投递的job是部署在多机房的，这也就降低单机房网络抖动造成的影响。</p><p style="word-break: break-all;white-space: normal;">高低优通道上线后，遇到过内网出网抖动，当时内网部属的job节点推送消息异常，而云上高优job节点可正常推送，很好的保障了高优消息的到达，进而保障了高优业务不受影响。</p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.高达功能</strong></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;white-space: normal;">高低优通道解决的是job到接入层的这一个环节，但消息推送联路涉及到多个环节，比如服务层到job、接入层到客户端。针对整个链路，通过实现必达机制来确保终端的到达率，简称高达功能。</p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015291" data-ratio="0.3619047619047619" data-s="300,640" data-type="png" data-w="525" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VfrCicSwOmpjUaibUAyUhjzfeFFkibCDmOA24kj0qHq5eBbYvHTq7LErQg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">功能实现：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">每条消息引入msgID，客户端收到消息后进行幂等去重和ack回执。<br></p></li><li><p style="word-break: break-all;margin-bottom: 15px;">服务端针对msgid进行ack检测，针对未ack的，有效期内再次重试下发。<br></p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">最终到达率&nbsp;=&nbsp;(1-(1-r)^(n+1))，其中：r为广播单次到达率，n为最大重试次数。<br></p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;">例如：r = 97%，n=2，那么最终到达率可以达到(1-(1-0.97)^(2+1))&nbsp;= 99.9973%<br></p></li></ul></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>其他优化</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>进出房消息</strong></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">有些业务场景，需要用到用户进出房消息，比如用户A进入直播间，页面会显示欢迎用户A进入房间，或者是加入在线榜单。</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">进房消息会存在丢失，需要有补偿机制。想到可以通过连接心跳来补偿进房消息，但心跳是持续不断的，连接在线期间，业务希望只收到一次进房消息，所以进房消息需要有幂等机制。<br></p></li><li><p style="word-break: break-all;">出房消息也会存在丢失，如果丢失了，业务无法从在线榜单剔除用户，此时也需要有补偿机制。此时就需要增加连接的状态机，通过心跳维护状态机，当心跳丢失时，认为连接断开，用户退房。</p></li></ul></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015292" data-ratio="0.36304909560723514" data-s="300,640" data-type="png" data-w="774" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4VYwkhUibbbq4plU00L4Fxtg54fDqxY4IzVqpkAZ2z4RlyZNCNDhjGjHQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>未来规划</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;"><br></p><div style="padding-right: 8px;padding-left: 8px;"><div style="line-height: 1.6;font-size: 16px;"><div style="padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">统一长连接服务经历数次迭代后，目前基本功能已经趋于稳定，后续对长连接服务进行改善和优化，主要集中在以下几个方向：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">数据化：进一步完善长连接全链路网络质量数据统计和高价值消息全链路追踪的能力；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">智能化：端上建联、接入点选择等能够根据实际环境进行自动化调整；</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">性能优化：接入层的连接模块中，处理上下行消息的携程进行共享，减少接入层的携程数，进一步提升单机性能和连接数。</p></li><li><p style="word-break: break-all;">功能扩展：新增离线消息功能等。</p></li></ul></div></div><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><br></p></div><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>提升到达率还有哪些可以优化的奇妙视角？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩幻星集马克杯一个</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月16日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 40%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015297" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754Sw7Se9O3y0XhzGowB8Gib4V8wpfjT00SRqpEic2DSGMzLo4MVn9Yibxxiaeq4ibVibaYOOhUxHHUickg3NQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247495155&amp;idx=1&amp;sn=b28609e5e3b2d860cbdd5e10d6ac2d8f&amp;chksm=cf2f28d6f858a1c00a84202fd7feba6323af3a342ce2fff544de7958123f254afcd5ce21d558&amp;scene=21#wechat_redirect" textvalue="DAGW：数据聚合网关的探索与实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">DAGW：数据聚合网关的探索与实践</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247497596&amp;idx=1&amp;sn=336b0f1c19d6314603f976d065dd6302&amp;chksm=cf2f3259f858bb4ff0e846e4be2cda17d1f1d87d06ecd2eee710b7931084e2e7546bc05f593b&amp;scene=21#wechat_redirect" textvalue="大型直播活动保障S13的实践和思考" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">大型直播活动保障S13的实践和思考</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498306&amp;idx=1&amp;sn=55c07cb782fa43bcb3bf0d5049ed3d34&amp;chksm=cf2f3f67f858b671056a65518889fd09e8529f5134acca8133f3babdda81859e9404285e028b&amp;scene=21#wechat_redirect" textvalue="会员购交易系统架构演进" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">会员购交易系统架构演进</a><span style="color: rgb(12, 182, 242);letter-spacing: 4px;text-align: center;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"></span></p></li></ul></div></div></div></div></div><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-size: 13px;letter-spacing: 4px;text-align: center;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: var(--articleFontsize);letter-spacing: 0.034em;text-align: justify;"></span><br></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="231" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>黄山成</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Flink Keyed State的优化与实践]]></title>
        <id>2247498930_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498930&amp;idx=1&amp;sn=90c621ef75f2605da763f2742c45b805&amp;chksm=cf2f3997f858b08106ebc33301e8a09639af50698cdc9836db56fcc359ecb21258b5f121aa0e#rd"/>
        <updated>2024-04-08T12:53:39.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 14.6341% 82.3529%;background-repeat: no-repeat;background-size: 156.944%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQKtfkOw2IYicfvpjyO57WjJ24HcWG9XS8SRYeg904O1yqX6fTxaicyribQ/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015261" data-ratio="0.75" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQKtfkOw2IYicfvpjyO57WjJ24HcWG9XS8SRYeg904O1yqX6fTxaicyribQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>张陈毅</p></div><div style="margin-top: 5px;text-align: justify;font-size: 12px;"><p style="text-align: center;white-space: normal;">哔哩哔哩资深开发工程师</p></div></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 53%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>张杨</p></div><div style="margin-top: 5px;font-size: 12px;"><p style="text-align: left;">哔哩哔哩资深开发工程师</p></div></div></div></div><div style="display: inline-block;vertical-align: middle;width: 32%;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 38.524%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQanjbzKhoQlDmnflfVUYFQt4GmVuessK8sog9G8337hugOiaAVNgicC0g/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img data-imgfileid="100015262" data-ratio="1.4538461538461538" data-s="300,640" data-type="jpeg" data-w="780" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQanjbzKhoQlDmnflfVUYFQt4GmVuessK8sog9G8337hugOiaAVNgicC0g/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>1.背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Flink SQL在业务使用中有较多的双流join场景，当左右流的流量都较大，Join的等待时间即使为1小时，Flink Keyed State（Flink State分Operator State和Keyed State，后文所有State均代表后者）的存储大小也很容易达到TB级（内部默认使用的是RocksDBStateBackend）。</p><p style="word-break: break-all;white-space: normal;">在State我们内部[1]之前就做了RT和长度的metric，当State的存储达到TB级别后，会发现State的scan/next/readNull请求RT会变得较高，另外双流Join不仅流量大，Join query的字段也较多，导致State的Value长度也较大，从而使得任务在流量高峰期CPU存在明显的周期性毛刺，根因是RocksDB的compaction引发。我们下面的内容主要是从业务场景跟进到RocksDB的读写行为，来优化RT耗时高的问题，并使用优化方案缓解compaction的压力。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>2.Flink Keyed State诊断</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">我们统计了内部的TB级别大State任务，其State均由双流Join Operator产生。Flink的双流Join有两类，一类是无时间区间限制的Regular Join，其左右流的State Key在Inner和Outer Join下均会存放单条RowData数据，在监控中会发现Key length普遍较大，这类作业在内部使用数量以及State大小均相对较小。另一类是有时间区间限制的Interval Join，以及内部基于Interval Join实现的延迟弹出数据的Latency Join，其左右流的State在大State任务中Key很小，而Value较大，如下图所示是大State任务LatencyJoin的写KV长度监控。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015263" data-ratio="0.45185185185185184" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQEGGPrD87a9Igib0libeAYGeNF0XJ6ic7oJ6ia1JLw1opWSMLIZw3ZB9fzw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.1 双流Join特性</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">第二类双流Join在内部使用数量和State存储大小均很大，内部的商业和AI这两个业务线中使用得最多，我们着重看一下这类Join在Flink的实现。</p><p style="word-break: break-all;white-space: normal;">这类双流Join Operator，在Flink中会使用两个State，分别缓存左流和右流的数据，其结构为MapState&lt;long,list&gt;，Key存放的是毫秒时间戳，Value存放的是当前毫秒时刻相同On表达式列下的所有RowData记录，一个RowData就是当前流在Join后需要被Project的所有字段合集。当左右流的一条记录被Project的字段越多，单个RowData存储的字段也就越多，一个RowData的长度由所有Project字段的长度之和决定，大State任务中一般左右流的Project数量和长度均较大，所以也就导致了一个时间戳下即使只有一条RowData，写入RocksDB的List序列化结果也会较长。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015259" data-ratio="0.35209235209235207" data-s="300,640" data-type="png" data-w="693" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQiaQWzod1HtsicpWYnI3CbRV9ic0bekaWV2taxTkDZN1kCtqZbd7y9F6ibA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">RocksDB的写流程示意图[2]如下，一对KV从client写入RocksDB中，会先写入WAL中（Flink中已关闭WAL），然后写入Memory table中，当Memory Table写满（阈值write_buffer_size=64MB）或主动触发flush（Flink checkpoint触发RocksDB的snapshot）后，会将数据刷入磁盘写入L0层的SST中，当L0层的文件数达到阈值（level0_file_num_compaction_trigger=4）会触发compaction操作，将L0层的所有数据和L1的数据合并并写入到L1中；当L1的存储大小达到阈值（max_bytes_for_level_base=256MB）后会触发compaction，将L1的文件和L2的若干个文件合并并写入L2；在L2及其以后，LN+1的存储大小为LN的10(max_bytes_for_level_multiplier)倍时均会触发compaction向LN+1合并数据。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015260" data-ratio="0.597872340425532" data-s="300,640" data-type="png" data-w="940" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQlo9L42WOLv5YZeZFgrS1IxtPlk7uYTrkcPd3NdLiaaJUSkiceBKsNzWw/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">将任务添加state.backend.rocksdb.log.level=DEBUG_LEVEL配置后会发现，TB级别的双流Join大State任务，RocksDB的SST层级会变成[2,4,41,98,0,0,0]，代表着L0至L7中SST文件个数，L3的文件数会十分多，这也是由于双流Join的两个特性决定的，一个是流量特别大，需要记录的KV数量庞大，另一个是前面提到的Value较长，导致整体的存储消耗也会较大，而RocksDB的层级分布，导致较多的数据存储到了L3，层级变多会导致compaction整体耗时变得较高。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>2.2 RocksDB读RT高</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">RocksDB的读流程示意图[2]如下，Client读取数据会先从Memory Table中查询，如果没有找到则在磁盘的L0层读取数据，由于在L0层的数据不是全局有序的，所以会依次读取L0层的所有文件。RocksDB的L1至LN每层数据在当前Level内是全局排序的，所有L1至LN中的一个K只会在一个SST文件中，如果L0层未查询到数据，则会依次在L1至LN中每层只查询一个SST文件，直到查询到数据结束。&nbsp;</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015264" data-ratio="0.7259414225941423" data-s="300,640" data-type="png" data-w="956" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQasbwcM2ClcJnfC58ouQHzbbJHYD0LiaTr6qMVPjKiaxNX3BEIQ57Xl4A/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在前文中我们提到过，双流Join的Key是时间戳，Value存放的是当前时间戳的数据集合List，左右流数据进入到Join Operator会在对应State中做一个Get请求，再将当前RowDate放入List中，随着时间的推移，会存在大量的Get请求击穿RocksDB，我们标记其为ReadNull，与此同时上文中提到双流Join大State的RocksDB L3层的文件数是比较多的，所有的ReadNull请求均会从L0访问至L3结束，整体读耗时是比较高的。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">另外这类Join的State是MapState&lt;long,list&gt;结构，会有两个地方调用Map的iterator。一个是对流数据Join当前State的RowData集合，另一个是由Timer State定时触发清理当前State的时间窗口外的数据，否则State会越来越大。而State中Map的iterator调用的是RocksDB的seek和next来查询数据，seek和next操作会将所有满足currentKey的数据遍历出来，同样会读到RocksDB的最底层Level的SST文件。</p><p style="word-break: break-all;white-space: normal;">我们通过监控发现大State的seek、next、readnull等读RT耗时99线比较高，达到了两位数的毫秒级，这对实时流计算来说是不期望看到的结果。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015265" data-ratio="0.44814814814814813" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQs3GWjgFicDZ8rhAnFR8GmIK8O1xCEUmsicRWoImLglML5HkyoHcBLW6Q/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>3.State优化</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">无论是读RT耗时变高，还是compaction导致CPU毛刺，都是因为State中的Value过大，导致SST的层级变多，扫描过多SST文件，读性能也就会有所下降。一条State记录，从L0到LN的过程，不仅会在跨层中被读写，而且在同层中，因其他数据compaction到当层，也会被多次读写，在高level的compaction中会发现磁盘的读写IO之和会达到400MB/s，读写中占比较大的数据是State的Value，如果Value在compaction中不被搬迁移动，那么可以大大降低IO和CPU毛刺，在做调研中发现了RocksDB社区的BlobDB[3]方案。</p><p style="word-break: break-all;white-space: normal;">RocksDB的BlobDB方案来自Wisckey[4]的KV分离，当一对KV被flush落盘时，如果Value长度大于阈值，会将Value写入Blob文件中，SST文件中仅记录Value在Blob的index，在大Value场景下，使用KV分离后SST文件的总大小和层级将会大大的降低。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015266" data-ratio="0.4185185185185185" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQydLPcJ3QfhAOLxA0JoEib569ibf15HlcG22kWTWA2CFdzm5iamGWTF3hA/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Flink社区中RocksDB最高版本[5]在去年调研时仅为RocksDB对应的6.20版本，而此版本还无法通过Java调用开启BlobDB，在与内部分布式存储团队沟通后，决定使用他们已线上运行的7.8.3版本来构建Flink的RocksDB，从而来使用BlobDB特性，于是我们将Flink原有的CompactionFilter等实现合并到了7.8.3的release中。</p><p style="word-break: break-all;white-space: normal;">经过适配并在大State中开启KV分离后，观察RocksDB日志发现SST的文件大小急剧下降，State Key也全聚集在了L0和L1这两层中。由于SST层级的降低，ReadNull请求访问到L1层就结束了，而seek和next请求在有数据的情况下，只需要额外访问一次对应的blob文件即可，若没有数据，对blob的IO读操作也可省略。最后的效果是ReadNull耗时全降到了百微妙左右，scan和next的RT 99线也降到了1毫秒左右。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015267" data-ratio="0.45092592592592595" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQyFvbOuauOv5cSEIeoP4G6ibS0NKcwHX1D2kffGDjOcv3Ba1uVjubPEQ/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">另外我们通过用户Case的双跑任务对比发现，开启KV分离的任务CPU毛刺有所弱化，CPU整体使用降低了50%。任务依旧存在少量的CPU毛刺高峰现象，通过RocksDB日志分析毛刺依旧来源于compaction，虽然SST的层级降低了，但是blob文件的GC还是存在，GC会将blob文件数据做搬迁工作，整合新文件和删除老blob文件，其工作会比较消耗磁盘IO和CPU资源，而blob的GC在现实中是无法关闭的，关闭blob GC会导致存储层文件只增不减。即使compaction依旧存在，我们也是享受到了升级RocksDB版本带来的优化的，高毛刺的频率相比老版本来说少了很多了。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015268" data-ratio="0.4981481481481482" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQibqPtwEzOdUO54QXGTjuzyD7o1g3L9cSnEoqiaSwoJIgjm6shPA4wLzg/640?wx_fmt=png&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>4.总结与展望</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">除了对大State做了KV分离外，小State的有一些任务会存在20min一次周期性毛刺现象，我们引用了分布式存储团队的InnerCompaction[6]补丁，KV长度均很小，L1层存储大小接近max_bytes_for_level_base，四次Checkpoint生成的4个L0层SST向L1层compaction会导致CPU毛刺现象产生，而InnerCompaction的优化原理是L0层的小文件在同层预先做compaction，避免频繁的与L1的数据做合并，防止IO放大。</p><p style="word-break: break-all;white-space: normal;">去年下半年在内部给用户推进Flink State的KV分离功能后，线上所有大State任务的CPU使用率都减少了20-50%。未来可能有如下几个方面会继续推进优化。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);" powered-by="xiumi.us"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">a) 将内部高版本Flink中的RocksDB完成升级。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">b) Flink做Checkpoint执行到RocksDB层的snapshot是比较轻的，和compaction不强关联的，后续可以考虑降低compaction的速率来达到进一步弱化CPU毛刺现象。</p><p style="word-break: break-all;white-space: normal;">c) 目前内部的KV分离还需要使用一个参数控制开启，后期期望能默认全局开启，KV分离对Value长度大小的阈值也期望能自适应，无需用户感知。</p></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>参考：</strong></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[1]<a href="https://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247491460&amp;idx=1&amp;sn=b2f81308a3d2f388f84f5d1f054c67fa&amp;scene=21#wechat_redirect" src="https://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247491460&amp;idx=1&amp;sn=b2f81308a3d2f388f84f5d1f054c67fa&amp;scene=21#wechat_redirect" data-linktype="2">https://mp.weixin.qq.com/s/E23JO7YvzJrocbOIGO5X-Q</a></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[2]https://blog.csdn.net/microGP/article/details/120416193</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[3]https://github.com/facebook/rocksdb/wiki/BlobDB</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[4]https://www.usenix.org/system/files/conference/fast16/fast16-papers-lu.pdf</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">[5]https://github.com/ververica/frocksdb</p><p style="word-break: break-all;white-space: normal;">[6]&nbsp;https://github.com/bilibili/rocksdb</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>Flink state还有哪些可以优化的奇妙视角？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>bilibili Goods小飞碟充电夜灯</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月12日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 40%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015271" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="887" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754TDdfjEcsAAqcNJ73BHibROQHLpPL2Jc1XRrQDFnmbkF0mCrmiasbX1SfYcGfLZicPGWibvm12ibmraiaKw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);" powered-by="xiumi.us"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494519&amp;idx=1&amp;sn=db67e443bdd2aa5337a1a180238c006b&amp;chksm=cf2f2e52f858a744bd5dae4e867b33361e28670c07dd3c6dd92bf4480f22be929e50c06da6ee&amp;scene=21#wechat_redirect" textvalue="云原生架构下B站Flink存算分离的改造实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">云原生架构下B站Flink存算分离的改造实践</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494294&amp;idx=1&amp;sn=99d7bd7d3edc2676a4a2e36549a827ec&amp;chksm=cf2f2fb3f858a6a579d65634a2b1fe0a520e822032ee687efc032ff9e022f1d8b45864cee7e9&amp;scene=21#wechat_redirect" textvalue="B站基于&nbsp;Flink&nbsp;的海量用户行为实时&nbsp;ETL 应用实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">B站基于&nbsp;Flink&nbsp;的海量用户行为实时&nbsp;ETL 应用实践</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247491358&amp;idx=1&amp;sn=80034b5b8a9987dc1c2ea3be402efb4f&amp;chksm=cf2cda3bf85b532d6d34496db0cf5a0e7d6b875576b4bbdeca9c9bbbebdcedacf61ce91320b4&amp;scene=21#wechat_redirect" textvalue="B站大数据质量务实" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">B站大数据质量务实</a></p></li></ul></div></div></div></div></div><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><br style="outline: 0px;"></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="2" data-is_biz_ban="0" data-origin_num="230" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp" style="margin-bottom: 0px;outline: 0px;"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe js_wx_tap_highlight" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/300?wx_fmt=png&amp;wxfrom=19" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="2" data-is_biz_ban="0" data-origin_num="22" data-isban="0" data-biz_account_status="0" data-index="1"></mp-common-profile></p><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>张陈毅&amp;张杨</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[B站海外商业化探索之路]]></title>
        <id>2247498906_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498906&amp;idx=1&amp;sn=f70830c331c79fe5b55de9c22424f27e&amp;chksm=cf2f39bff858b0a9dc77b33eccadc0e95027db44f7ff80f4c7c7ca5b42fed47c46f40568c365#rd"/>
        <updated>2024-04-01T12:29:02.000Z</updated>
        <author>
            <name>刘诗雨&amp;梁凯</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[开放平台 - 互动玩法演进之路]]></title>
        <id>2247498858_1</id>
        <link href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247498858&amp;idx=1&amp;sn=9cd3c1b8b0b1921f951f8e0174b9c343&amp;chksm=cf2f394ff858b059744239e77771725db749f654ec0aa963e96c092ff57b11c1d7c4957eb250#rd"/>
        <updated>2024-03-28T12:59:12.000Z</updated>
        <summary type="html"><![CDATA[<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 44.7974%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdVsFia5fyXsu1icrKXOWznAhG0BMq23uibHTe4XZLvThgkVZ2WFWb9Xnxg/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015155" data-ratio="1.400437636761488" data-s="300,640" data-type="jpeg" data-w="914" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdVsFia5fyXsu1icrKXOWznAhG0BMq23uibHTe4XZLvThgkVZ2WFWb9Xnxg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>吴盛</p></div><div style="margin-top: 5px;text-align: justify;font-size: 12px;"><p style="text-align: center;white-space: normal;">哔哩哔哩高级开发工程师</p></div></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 53%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>张梦瑶</p></div><div style="margin-top: 5px;font-size: 12px;"><p style="text-align: left;">哔哩哔哩高级开发工程师</p></div></div></div></div><div style="display: inline-block;vertical-align: middle;width: 32%;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: center center;background-repeat: no-repeat;background-size: cover;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdibiaibYI2Fxj4wyaPSjw3cXp31eiaKXpQIibFSXReR9I1CZqOnaNWBTIlQg/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015151" data-ratio="0.6666666666666666" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdibiaibYI2Fxj4wyaPSjw3cXp31eiaKXpQIibFSXReR9I1CZqOnaNWBTIlQg/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 19.086%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdpGoOdnTX5bpHkySFqr7zNytcaROpiaW2ZoFZuep1Y6dlTfVoRwCE9YQ/640?wx_fmt=png&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015152" data-ratio="1.5391304347826087" data-s="300,640" data-type="png" data-w="460" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdpGoOdnTX5bpHkySFqr7zNytcaROpiaW2ZoFZuep1Y6dlTfVoRwCE9YQ/640?wx_fmt=png&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>贺一科</p></div><div style="margin-top: 5px;text-align: justify;font-size: 12px;"><p style="text-align: center;white-space: normal;">哔哩哔哩高级开发工程师</p></div></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 53%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>魏骏文</p></div><div style="margin-top: 5px;font-size: 12px;"><p style="text-align: left;">哔哩哔哩资深开发工程师</p></div></div></div></div><div style="display: inline-block;vertical-align: middle;width: 32%;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 81.25% 62.5%;background-repeat: no-repeat;background-size: 155.556%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdZOWAUKmOicmsf5QOTmqhPngJl4rb4UY3jqzjd1j4FicMVzJTzmgZsWng/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img data-imgfileid="100015154" data-ratio="0.75" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdZOWAUKmOicmsf5QOTmqhPngJl4rb4UY3jqzjd1j4FicMVzJTzmgZsWng/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>1. 背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">随着直播业务和用户规模日益壮大，如何丰富直播间内容、增强直播间内用户互动效果，提升营收数据变得更加关键。为此，直播互动玩法应运而生。通过弹幕、礼物、点赞、大航海等方式，用户可以参与主播的直播内容。B站还通过开放平台，为第三方厂商和开发者提供了强大的技术支持，让直播互动玩法更加便捷、稳定和高效，为用户和主播创造了更多的乐趣和价值。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015153" data-ratio="0.2834331337325349" data-s="300,640" data-type="png" data-w="1002" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkd04MrGXYpAJlF3DcOtrNTmr2Jor2rg3VWY4NJN8eoaOGT6PAgJ0qO1g/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：星体工作室&nbsp;互动玩法案例</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>2. 平台建设</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在着手开发之前，我们需要确立清晰的业务划分边界，特别是涉及多方参与的开放平台互动玩法业务。这有助于避免日积月累的问题，确保未来的发展不受制于历史债务。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们的业务划分主要集中在几个核心场景和能力模块上：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">开发者管理平台：<br>与开发者互动，包括入驻流程、应用审核、礼物与面板审核。<br>作为开发者数据的展示出口，为他们提供数据回收的支持。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">应用商店平台：<br>与主播互动，包括平台与直播姬的应用展示与获取。<br>提供定制化应用推荐算法的出口，以提升应用的曝光和吸引力。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">应用交互平台：<br>与直播间用户互动，利用事件平台进行控制，包括开关礼物与面板。<br>互动玩法期间数据流转等行为。<br>监测与标记应用的实时状态，确保流畅的用户体验。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">结算平台：<br>与营收互动，包括应用期间营收数据的统计、落库和对账。<br>为确保透明度和准确性，提供完善的结算支持。</p></li></ul><p style="word-break: break-all;white-space: normal;">因此我们设计的如下的业务模块分层：</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015157" data-ratio="0.5990740740740741" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdyhCibK8dO2WzIpTk3lr4iaic3fE4eKBBpLKLMUht3WHXuO3xOiabd4VOcw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：平台架构</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>3. 项目生命周期</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="303" data-imgfileid="100015159" data-ratio="0.5351851851851852" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 578px;height: 309px;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdU7pZ4obRBELvLcCmy96MmcxLlf6nWXFthC1wv4etZNNcKJQtAJnZfw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：互动玩法生命周期</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">社区优先的原则确保了我们平台的演进和提升是以开发者和用户的需求为中心的良好策略，明确了业务边界之后，围绕互玩的整个生命周期，我们将重心放在四个核心提升目标上：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">开发者入驻效率与权益保障：<br>通过简化入驻流程，提供清晰的文档和支持，确保开发者能够快速且顺利地接入平台。<br>提供快速且准确的审核机制，加速应用上线，促进生态系统的快速发展。<br>提供明确的营收手段与完善的对账系统，保证开发者收益。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">主播使用体验：<br>提供直观且易用的工具和功能，以增强主播的覆盖率和互动性，提升直播质量。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">直播间用户体验：<br>优化直播间界面，降低用户参与门槛。<br>提供有趣、多样化的互动玩法，激发用户的参与热情，提高用户粘性。</p></li><li><p style="word-break: break-all;">平台管控能力：<br>强化对内容的管理和监督，确保内容的合法性与安全性。<br>提供丰富的工具，快速响应违规行为，维护平台生态安全与健康。</p></li></ul></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.1 入驻与开发</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在整个互玩生命周期过程中，开发者接入平台与开发作为起点，门槛会直接影响开发者数量与互玩的供给速度，有一些问题是我们需要思考并解决的：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">开发者如何快速搭建模型？</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">开发者如何低成本进行数据交互调试？</p></li><li><p style="word-break: break-all;">个人开发者在缺少专业的礼物UI设计师的情况下如何进行礼物设计？</p></li></ul></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.1.1 SDK&amp;Demo</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们明白对事物的认识往往从“是什么”开始，然后才能理解“为什么是这样”。作为首次接入开放平台的开发者，理解众多API和调用文档并梳理出清晰的交互流程确实需要时间。同时由于开发者的历史开发背景各异，对官方接入文档的理解也会有所不同。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">为了降低开发者的开发成本并减轻研发的解答压力，我们在完善官方技术文档的同时，提供了不同语言的示例，以帮助开发者建立概念模型：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">Unity&amp;C#客户端SDK</p></li><li><p style="word-break: break-all;">Python&amp;Golang&nbsp;Demo</p></li></ul></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015158" data-ratio="0.6148148148148148" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdKoXtsoiammSicd7r9yIB1VscHuoibJQUlaO7o2ryvia4te6LVqxJvibfgfw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：互动玩法接入SDK&amp;Demo</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.1.2 启动调试能力</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">测试阶段是完整的应用开发流程中不可或缺的一个重要环节，未经充分测试的应用可能存在潜在的不可预估的风险，为了辅助开发者在应用上架之前能够进行充分且完善的测试，我们解决了以下两点问题：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><br></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Q：开发者在应用开发完成之后如何在真实环境下测试应用功能？</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">A：在应用通过审核之前，开发者可以选择将其直播间设置为白名单直播间，这就意味着开发者可以在真实的线上环境中对其开发的应用进行完整的测试与功能回归。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><br></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">Q：送礼、发送醒目留言以及大航海是互动玩法交互的重要组成部分，在线上环境应该如何进行这几种交互操作的调试？</p><p style="word-break: break-all;white-space: normal;">A：这几种直播间用户参与的高成本行为，让开发者在线上环境使用正常流程进行大量的测试显然是不合理的。为了解决这个问题，我们提供了开发者调试工具。通过这个此工具，开发者可以通过后台操作主动触发由开放平台发出的长连接消息内容（包括弹幕、送礼、大航海和醒目留言），从操作到出口消息的过程则由平台侧保证数据的正确性。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015160" data-ratio="0.6388888888888888" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdHZ9iaH1a217JMBciaicK847GTtbXkKlx0UPLkhchSm3uz3hmP1Q0IYDlg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：开发者调试工具</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.1.3 官方素材库</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在互动玩法系统初期，开发者需要手动设计并上传礼物素材，不仅增加了开发者的研发成本，也加大了运营审核的难度和成本，从而导致素材管理混乱。为了解决这一问题，我们为开发者提供了一个更便捷的解决方案：官方素材库。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">现在，开发者只需从官方素材库中选择适合的内容，提交创建礼物即可。这一方案在业务规范性方面有很大的提升，同时降低了设计成本和审核成本。为整个互动玩法系统创造了更为有序和统一的环境，促进了生态的可持续发展。</p><p style="word-break: break-all;white-space: normal;">同时为了确保官方素材库中的礼物符合用户需求，我们会定期进行用户调研。并且也会定期更新官方素材库，添加新的礼物元素和主题，以满足用户不断变化的需求和兴趣。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015156" data-ratio="0.4935185185185185" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdRqA0MYZZHDsWwBicXPLHsCiaibicCwJ24qrEgiaDsr8lic93tNvkNCNuuVMg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：官方礼物素材库</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.2 提交与审核</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.2.1 包管理工具</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">当进行互动玩法项目的提审并需要上传包体时，如何有效地避免被当作一个网盘服务？这个时候我们可以反向利用单点故障理论进行思考。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">单点故障理论：系统中存在一个或一些关键的组件、环节或节点，如果其中的任何一个被破坏、故障或失效，可能导致整个系统的崩溃或失效。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们可以通过分析利用平台作为网盘的使用路径来找到其专属单点故障：</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">获取上传链接</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">上传文件</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">进行持久化存储</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">下载文件</p></li></ol><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在不影响正常业务逻辑的情况下，我们针对第3步进行处理，持久化存储追加前提条件，提升存储门槛，以业务的视角控制有效文件的判定，定时扫描删除无效包体。</p><p style="word-break: break-all;white-space: normal;">同时这个问题普遍出现在开放平台的各个业务场景，因此我们搭建了一个包管理系统，统一收口这一业务场景。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="417" data-imgfileid="100015165" data-ratio="0.6648148148148149" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 578px;height: 384px;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdVCdMG6Fia1nO5jSzurq6ZpmIZR4nqnCnLvHyLK8qSg4qUdNtsJcNiasQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：包生命周期管理</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.2.2 运营审核工具</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们可以通过分析利用平台作为网盘的使用路径方面进行审核：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">互动玩法内容是否合规，是否存在敏感内容？</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">互动玩法调用模式是否符合开放平台规范？</p></li></ul><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">作为运营，只能够在审核的使用过程中，对于互动玩法内容作出合规性校验，因此我们为运营提供基础的合规性校验工具对于包体进行校验，为运营提供审核依据。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">该工具需同时满足两个条件：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">监听服务对于开放平台的请求</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">统计接口的调用频率</p></li></ul><p style="word-break: break-all;white-space: normal;">在技术调研初期，想通过抓包工具对数据进行分析，监听https请求的443端口流量，并且从流量中过滤出来host为"<span style="color: rgb(12, 182, 242);text-decoration: underline;">live-open.biliapi.com</span>"的相关请求，即对开放平台相关请求。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015162" data-ratio="0.3398148148148148" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdwet5ibzQ8icTEcHR7HVFVfENx9muDopsOpVPIjI8XV9ibyBUhBoz3uMZA/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：监听端口流量</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">经过测试，由于通过抓包工具是在七层协议中传输层截取的数据，基于https协议的请求数据都被加密，无法获取具体的请求内容，不满足条件2，因此该方案被否决。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015163" data-ratio="0.31296296296296294" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkd8hmVMz4zAwO0v8uv3qEy5EXKicvK2t0lqfBiaWFynHXCXib9H2tqKS7sA/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：抓包结果</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">为了获取接口调用的详细情况，有两个数据来源，调用方和被调用方。在无法强制在调用方代码中插入统计逻辑的情况下，目光便聚焦在被调用方，但线上服务器用作测试统计，显然是不合理的。</p><p style="margin-bottom: 15px;word-break: break-all;white-space: normal;">线上真实环境不能用，便考虑使用仿真沙盒环境， 此时代理转发的方案呼之欲出，大概思路如下：</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;word-break: break-all;">用户更改本地host配置，把开放平台的域名指向localhost</p></li><li><p style="margin-bottom: 15px;word-break: break-all;">本地启动一个代理服务，监听<strong>443</strong>端口</p></li><li><p style="margin-bottom: 15px;word-break: break-all;">本地代理负责转发"<span style="text-decoration: underline;color: rgb(12, 182, 242);">live-open.biliapi.com</span>"的相关请求与记录接口调用结果</p></li><li><p style="word-break: break-all;">本地服务关闭时输出调用结果。</p></li></ol></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015166" data-ratio="0.9268518518518518" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdMvd7bc1WG6apiaRLn2tj7icLfJ8uvGUhcsYMLibNJwojqufzGiaHhRYTYg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：沙盒代理流程</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015164" data-ratio="0.6731481481481482" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkd8843yfsiacAbfCryJIZxsHV1icrf4pEcn80x7DsWib3FKy6ux7R47pTYg/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：检测结果</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.3 使用与结算</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.3.1 身份码体系</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">互动玩法的使用与直播房间强绑定，因此在互动玩法开启时，玩法客户端需要一个途径与当前直播间进行关联操作，基于此问题，我们考虑过以下两种途径：</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;" powered-by="xiumi.us"><p><br></p><table resolved="" width="775"><colgroup><col style="width: 198.141px;"><col style="width: 213.656px;"><col style="width: 363.172px;"></colgroup><tbody><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><strong><span style="font-size: 14px;">提供方式</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><strong><span style="font-size: 14px;">优势</span></strong></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;"><p><strong><span style="font-size: 14px;">劣势</span></strong></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;">开启互动玩法后主播输入房间号</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;">使用门槛低，可在OBS使用</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;">安全性低，主播可以在他人直播间开启互动玩法</span></p></td></tr><tr><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;">读取主播的登陆态传递房间号</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;">安全性中，主播之间不可互相开启</span></p></td><td colspan="1" rowspan="1" style="border-color: rgb(193, 199, 208);padding-top: 7px;padding-bottom: 7px;vertical-align: top;min-width: 8px;" align="left" valign="top"><p><span style="font-size: 14px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.034em;">使用门槛高，只能在直播姬使用<br></span></p><p><span style="font-size: 14px;">开发者可以开启任意房间的互动玩法</span></p><p><br></p></td></tr></tbody></table><p><br></p></div><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在以上两种途径的劣势都不可接受的情况下，我们需要一种新的房间号标识的传输方式，并且同时要满足以下几个要求：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">不依赖直播姬的登陆态，主播在使用其他直播工具时依然可以开启互动玩法</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">主播之间不可知，主播不可以通过一个公开标识启动其他主播的应用</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">开发者不可知，玩法开发者无法获取任意主播的应用</p></li></ul><p style="word-break: break-all;white-space: normal;">因此我们推出了一套独立标识（即身份码系统），主播可以生成唯一标识与房间号绑定，并且在公域对他人不可见，确保主播之间以及主播与开发者之间的信息是隔离的，与开放平台的交互通过身份码进行，由开放平台进行数据转换，并且同时为了避免身份码泄漏造成安全问题，提供定时刷新以及手动强制刷新能力，保证数据的合规安全。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;color: rgb(12, 182, 242);"><p><strong>3.3.2 互动结算</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">与开发者分成由互动玩法产生的营收流水是构建良好合作模式的关键。然而，如果仅以互动启动时间作为计算依据，可能会导致不合理的结果，因为在启动期间产生的舰长、醒目留言等营收行为都会被计算在内。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">为了解决这个问题，我们提出了一个与互动玩法紧密相关的流水计算依据：互动礼物。每一个互动玩法都有自己特定的礼物，我们只统计由互动礼物产生的营收。这样可以准确反映互动玩法的实际贡献，避免了其他不相关因素的干扰。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">通过将互动礼物作为流水计算的依据，我们希望能够建立一个更公正、透明且与互动玩法紧密相关的分成机制，从而激励更多的开发者参与。这不仅可以提高开发者的积极性，也有助于形成一个健康、正向循环的互动生态。</p><p style="word-break: break-all;white-space: normal;">由于不同的互动玩法的分成比例不同且可以实时调整，这给我们的管理和感知带来了挑战。为了有效应对这些变化，我们需要建立一套与公司内部结算体系紧密相关的结算系统。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015169" data-ratio="0.6388888888888888" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdHicjpadkaUbPHoZsShqTYOgupsvC1E11vWIdrocKv9H3GLzHibMBiazQw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：结算架构</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">同时为了保障公司和开发者的权益，我们需要进行流水对账工作，主要包括以下两个维度：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">实时对账：在互动玩法运行过程中，建立实时对账系统，实时追踪和核对每一笔交易的流水，以便及时发现和解决可能出现的问题。</p></li><li><p style="word-break: break-all;">日流水对账：日流水对账是对实时对账的补充，也是在出具日账单前的最后核查工作。通过日流水对账，我们可以确保对账的准确性和完整性。</p></li></ul></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="358" data-imgfileid="100015171" data-ratio="0.6185185185185185" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 578px;height: 357px;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdwPngnYfosqRLyfepPRTyQpJ3dn9ookWFrh5pBVFY6NSkH7LaxgcaCQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：结算对账流程</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3.4 监控与反馈</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">在开放平台的互动玩法系统的迭代维护过程中，确保系统的安全性和鲁棒性是至关重要的。面对各种不确定性、噪声以及变化，保障系统在这些情况下能够保持稳定的基本能力是一个重大因素。考虑到互动玩法系统的调用方均为外部开发者，相比公司内部业务，我们需要更加严格的管控措施。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">上线并不是互动玩法生命周期的终点，我们采取了一系列措施来持续跟踪监控系统，对系统bug进行触达反馈，并对恶意调用进行限流或封禁，以确保平台高效运转或在极端情况下降低运行。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">以下是我们采用的一些措施：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;"><strong>安全中心体系：</strong>为防止突发流量的恶意请求，我们将互玩相关接口接入开放平台统一的安全管控中心。超过预设限制的调用方将被一段时间封禁，并随着触发次数的增加，封禁时间会逐渐延长，后续可以单独讨论一下安全中心的相关建设。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;"><strong>监控大盘与数据统计：</strong>除了突发流量，开发者频繁的错误请求也是常见问题。我们在请求时进行上报统计，并将数据接入公司的监控平台，实时观察和统计。这有助于降低告警的噪音，同时提高对问题的敏感度。</p></li><li><p style="word-break: break-all;"><strong>线上问题反馈：</strong>针对互动玩法内的bug，我们为主播提供了专门的反馈渠道。通过定期机器人同步，运营团队能够将问题及时反馈给开发者，从而实现问题的快速定位和解决。</p></li></ul></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100015170" data-ratio="0.33240740740740743" data-s="300,640" data-type="png" data-w="1080" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdyXyhk7KDmKLvXale8DOOUtQ33t67nMibMmnpZEZaiaWDibD9icic7ticXMyw/640?wx_fmt=png&amp;from=appmsg"></p></div><div style="text-align: center;" powered-by="xiumi.us"><p><sup>图：监控大盘</sup></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>4. 未来展望</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">B站的互动玩法目前仍在发展完善阶段，我们经历了从0到1的探索阶段，并结合开放平台的体系完成了全链路的建设与搭建。然而，在1到100的发展过程中，相比市场中的竞品，我们仍需不断演进与探索。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们面临的挑战有以下几个方面：</p><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;"><strong>数据实时分析能力不足：</strong>在互动玩法过程中，我们实时数据分析能力不足。强化数据预警分析能力可以帮助我们及时地发现潜在问题并做出相应调整。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;"><strong>商业化体系尚待完善：</strong>我们需要提升直播间用户的消费能力，同时深入挖掘直播间广大用户的潜在商业价值。完善商业化体系将有助于增加收入来源并提高用户参与度。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;"><strong>超前思考系统稳定性建设：</strong>随着上架的互玩和使用的主播扩大，我们需要以超前的思维布局，持续思考和落地系统的稳定性建设。这包括技术和流程的不断优化，以确保系统的稳定性和用户体验。</p></li></ul><p style="word-break: break-all;white-space: normal;">在面对这些挑战时，通过持续的努力和创新，我们相信可以不断优化互动玩法系统，更好地满足用户需求，使其在市场中脱颖而出。</p><p style="word-break: break-all;white-space: normal;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.034em;"><br></span></p><p style="word-break: break-all;white-space: normal;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.034em;">更多体验欢迎访问开放平台官网地址：</span><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.034em;text-decoration: underline;color: rgb(12, 182, 242);">https://open-live.bilibili.com/</span></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;"><strong><span style="color: rgb(255, 102, 149);">基于开放平台的直播间互动形式，你还有哪些想法？</span></strong>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>bilibili Goods小飞碟充电夜灯</strong></span>（见下图）。<span style="color: rgb(255, 102, 149);"><strong>4月2日中午12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 40%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100015168" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="887" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RjGic3P62Ixqia8JhvlDVDkdbpcAbHGJOs5iarYbK8lfzepJIxLPYicWtZgMictxyGePlSe1E5SHet2ibw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);" powered-by="xiumi.us"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247494862&amp;idx=1&amp;sn=f54dc16ab1ae7e7cb38bbb642fa510f9&amp;chksm=cf2f29ebf858a0fdaa5095b172702e65bd186c66c563cba1d45dd2d701decae09d4d437f4b06&amp;scene=21#wechat_redirect" textvalue="直播互动开放技术探索之路" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">直播互动开放技术探索之路</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247485875&amp;idx=1&amp;sn=6fdbded2aed33a1a60fc78478f2f5bc2&amp;chksm=cf2ccc96f85b4580a91773004a06594fa4c3f5a7a29e7cb54b1a0d3a6ac489afabe90d153851&amp;scene=21#wechat_redirect" textvalue="开放平台视频投递流程的演进与思考" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">开放平台视频投递流程的演进与思考</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247497385&amp;idx=1&amp;sn=4732d7b5d077fe1afe2660d330e43ba6&amp;chksm=cf2f338cf858ba9ae217c9f3644d2cb7bfda35131f3beaf5bab6dd0287257be9499063cbf0a0&amp;scene=21#wechat_redirect" textvalue="语聊房架构演进实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">语聊房架构演进实践</a></p></li></ul></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;font-size: 13px;letter-spacing: 4px;" powered-by="xiumi.us"><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">业务线</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" style="outline: 0px;color: var(--weui-LINK);cursor: pointer;"><span style="outline: 0px;color: rgb(12, 182, 242);">多媒体</span></a></p><p style="margin-bottom: 0px;outline: 0px;font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 13px;letter-spacing: 4px;text-align: center;white-space: normal;background-color: rgb(255, 255, 255);"><br></p><p class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754SVM7VMibhzz9AicOz5qdQ5oaN6TgXhbVyGHQYPwBErEYQCOnhibA1Qp431JkpPKY0qGhT0EfDchicXMQ/0?wx_fmt=png" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="0" data-is_biz_ban="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/0?wx_fmt=png" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="0" data-is_biz_ban="0"></mp-common-profile></p><p><br></p></div></div><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>]]></summary>
        <author>
            <name>B站主播生态组</name>
        </author>
    </entry>
</feed>