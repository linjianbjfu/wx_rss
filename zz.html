<div style="line-height: 1.6;font-size: 16px;"><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>本期作者</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin: 10px 0%;justify-content: center;display: flex;flex-flow: row nowrap;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: middle;width: 32%;margin-top: 10px;align-self: center;flex: 0 0 auto;height: auto;"><div style="font-size: 32px;margin: 10px 0%;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: bottom;margin: auto;width: 3em;height: 3em;border-radius: 100%;overflow: hidden;background-position: 0% 45.9532%;background-repeat: no-repeat;background-size: 100%;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RFIjDhHyCfk6jU6tYC7ggj9ibsr8ZO7F5hXTHwKoJMWNPdopWIibiaJ2xjxjOXQfwZeGMFFdWIkEbfw/640?wx_fmt=jpeg&amp;from=appmsg&quot;);"><p style="width: 100%;height: 100%;overflow: hidden;line-height: 0;"><img class="rich_pages wxw-img" data-imgfileid="100014714" data-ratio="1.5148148148148148" data-s="300,640" data-type="jpeg" data-w="1080" style="width: 100%;height: 100%;opacity: 0;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RFIjDhHyCfk6jU6tYC7ggj9ibsr8ZO7F5hXTHwKoJMWNPdopWIibiaJ2xjxjOXQfwZeGMFFdWIkEbfw/640?wx_fmt=jpeg&amp;from=appmsg"></p></div></div></div><div style="display: inline-block;vertical-align: middle;width: 48%;align-self: center;flex: 0 0 auto;"><div style="text-align: justify;" powered-by="xiumi.us"><p style="white-space: normal;"><br></p></div><div style="margin-top: 0.5em;margin-bottom: 0.5em;" powered-by="xiumi.us"><div style="display: inline-block;"><div style="border-bottom: 1px solid rgb(0, 0, 0);display: inline-block;padding-right: 0.8em;padding-left: 0.8em;color: rgb(0, 0, 0);"><p>卫智雄</p></div><div style="margin-top: 5px;text-align: justify;font-size: 14px;"><p style="text-align: center;white-space: normal;">哔哩哔哩高级运维工程师</p></div></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>一. 背景</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">如下配置所示，我们在 /etc/resolv.conf 中配置了两个 nameserver，其中 server2 在灾备机 房 ，作为一种 failover 策略。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">nameserver server1</span></code><br><code><span class="code-snippet_outer">nameserver server2</span></code><br><code><span class="code-snippet_outer">options timeout:<span class="code-snippet__number">1</span> attempts:<span class="code-snippet__number">1</span></span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">我们的预期是如果 server1 服务正常，则所有的 DNS 请求应该由 server1 处理，且 server2 故障不应对 业务有任何影响 。只有当 server1 服务异常，DNS 请求才应该重试到 server2。</p><p style="word-break: break-all;white-space: normal;">然而我们在线上观察到一直有 AAAA 类型的 DNS 请求发送到 server2，而且如果 client 到 server2 的网络异常时，业务的 http 请求耗时会增加 1s，这并不符合预期。同时因为我们的内网域名都没有 AAAA 记录，且内网服务器也是关闭了 IPv6 协议的，AAAA 请求也不符合预期。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>二. 问题排查</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">经过和业务同学求证，相关程序语言为 Go ，请求使用的是 Go 原生 net 库。在 Go net 库中，最经常使用的方式如下：</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__function">package main</span></span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__title">import</span> <span class="code-snippet__params">(</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"net"</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"net/http"</span></span></code><br><code><span class="code-snippet_outer">)</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet_outer">func <span class="code-snippet__title">main</span><span class="code-snippet__params">()</span> </span>{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;http.Get(<span class="code-snippet__string">"https://internal.domain.name"</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;net.Dial(<span class="code-snippet__string">"tcp"</span>, <span class="code-snippet__string">"internal.domain.name:443"</span>)</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>1. 梳理源码</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">让我们顺着源码分析 net 库的解析逻辑。无论是 http.Get 还是 net.Dial 最终都会到 <span style="color: rgb(255, 102, 149);">func (d *Dialer) DialContext() </span>这个方法。然后层层调用到 <span style="color: rgb(255, 102, 149);">func (r *Resolver) lookupIP() </span>方法，这里定义了何时使用 Go 内置解析 器或调用操作系统 C lib 库提供的解析方法，以及&nbsp;/etc/hosts&nbsp;的优先级。</p><p style="word-break: break-all;white-space: normal;">同时补充一个比较重要的信息：windows&nbsp;、darwin(MacOS等)优先使用 C lib 库解析，debug 时需要注意。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">func (d *Dialer) DialContext(ctx context.Context, network, address <span class="code-snippet__built_in">string</span>) (Conn, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;addrs, err := d.resolver().resolveAddrList(resolveCtx, <span class="code-snippet__string">"dial"</span>, network, address, d.LocalAddr)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">func (r *Resolver) resolveAddrList(ctx context.Context, op, network, addr <span class="code-snippet__built_in">string</span>, hint Addr) (addrList, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;addrs, err := r.internetAddrList(ctx, afnet, addr)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">func (r *Resolver) internetAddrList(ctx context.Context, net, addr <span class="code-snippet__built_in">string</span>) (addrList, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;ips, err := r.lookupIPAddr(ctx, net, host)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">func (r *Resolver) lookupIPAddr(ctx context.Context, network, host <span class="code-snippet__built_in">string</span>) ([]IPAddr, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;resolverFunc := r.lookupIP</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;ch := r.getLookupGroup().DoChan(lookupKey, func() (any, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> testHookLookupIP(lookupGroupCtx, resolverFunc, network, host)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;})</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">func (r *Resolver) lookupIP(ctx context.Context, network, host <span class="code-snippet__built_in">string</span>) (addrs []IPAddr, err error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> r.preferGo() {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> r.goLookupIP(ctx, network, host)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;order, conf := systemConf().hostLookupOrder(r, host)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> order == hostLookupCgo {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> cgoLookupIP(ctx, network, host)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;ips, _, err := r.goLookupIPCNAMEOrder(ctx, network, host, order, conf)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> ips, err</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">我们线上的操作系统是 Debain，确认会使用 Go 内置解析器。所以下一步来到了&nbsp;<span style="color: rgb(255, 102, 149);">func (r *Resolver)&nbsp;goLookupIPCNAMEOrder()&nbsp;</span>方法。这 里我们可以通过 qtypes 看到如果&nbsp;<span style="color: rgb(255, 102, 149);">net.Dial</span>&nbsp;的&nbsp;<span style="color: rgb(255, 102, 149);">network&nbsp;</span>参数传入的是&nbsp;<span style="color: rgb(255, 102, 149);">tcp&nbsp;</span>，域名的 A 和 AAAA 记录都会被查询，无论服务器是否关闭 ipv6。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">func (r *Resolver) goLookupIPCNAMEOrder(ctx context.Context, network, name <span class="code-snippet__built_in">string</span>, order hostLookupOrder, conf *dnsConfig) (addrs []IPAddr, cname dnsmessage.Name, err error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;lane := make(chan result, <span class="code-snippet__number">1</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;qtypes := []dnsmessage.Type{dnsmessage.TypeA, dnsmessage.TypeAAAA}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">switch</span> ipVersion(network) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">case</span> <span class="code-snippet__string">'4'</span>:</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;qtypes = []dnsmessage.Type{dnsmessage.TypeA}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">case</span> <span class="code-snippet__string">'6'</span>:</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;qtypes = []dnsmessage.Type{dnsmessage.TypeAAAA}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;var queryFn func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;var responseFn func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) result</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> conf.singleRequest {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;queryFn = func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) {}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;responseFn = func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) result {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsWaitGroup.Add(<span class="code-snippet__number">1</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;defer dnsWaitGroup.Done()</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p, server, err := r.tryOneName(ctx, conf, fqdn, qtype)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> result{p, server, err}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;} <span class="code-snippet__keyword">else</span> {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;queryFn = func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsWaitGroup.Add(<span class="code-snippet__number">1</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;go func(qtype dnsmessage.Type) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p, server, err := r.tryOneName(ctx, conf, fqdn, qtype)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lane &lt;- result{p, server, err}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsWaitGroup.Done()</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}(qtype)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;responseFn = func(fqdn <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) result {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> &lt;-lane</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">for</span> _, fqdn := range conf.nameList(name) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">for</span> _, qtype := range qtypes {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;queryFn(fqdn, qtype)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">for</span> _, qtype := range qtypes {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;result := responseFn(fqdn, qtype)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">从&nbsp;<span style="color: rgb(255, 102, 149);">goLookupIPCNAMEOrder&nbsp;</span>方法中我们可以看到由&nbsp;<span style="color: rgb(255, 102, 149);">tryOneName</span>&nbsp;方法分别处理 A 和 AAAA 记录。深入&nbsp;<span style="color: rgb(255, 102, 149);">tryOneName&nbsp;</span>内部，我们终于发现具体的 nameserver 选择逻辑，在某些错误情况下会重试请求到下一个 nameserver。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">func (r *Resolver) tryOneName(ctx context.Context, cfg *dnsConfig, name <span class="code-snippet__built_in">string</span>, qtype dnsmessage.Type) (dnsmessage.Parser, <span class="code-snippet__built_in">string</span>, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;q := dnsmessage.Question{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;Name: &nbsp;n,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;Type: &nbsp;qtype,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;Class: dnsmessage.ClassINET,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">for</span> i := <span class="code-snippet__number">0</span>; i &lt; cfg.attempts; i++ {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">for</span> j := uint32(<span class="code-snippet__number">0</span>); j &lt; sLen; j++ {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;server := cfg.servers[(serverOffset+j)%sLen]</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p, h, err := r.exchange(ctx, server, q, cfg.timeout, cfg.useTCP, cfg.trustAD)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> err := checkHeader(&amp;p, h); err != nil {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsErr := &amp;DNSError{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Err: &nbsp; &nbsp;err.Error(),</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name: &nbsp; name,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Server: server,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> err == errServerTemporarilyMisbehaving {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsErr.IsTemporary = <span class="code-snippet__literal">true</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> err == errNoSuchHost {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__comment">// The name does not exist, so trying</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__comment">// another server won't help.</span></span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dnsErr.IsNotFound = <span class="code-snippet__literal">true</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> p, server, dnsErr</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lastErr = dnsErr</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">continue</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>&nbsp;2. 线上 debug</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">接下来我们可以构造一个简单的程序在线上 debug，看看到底是因为 原因导致 AAAA 请求重试到了下一个 nameserver。(tips: debug 需要把 resolv.conf 的 timeout 调长一些)</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__function">package main</span></span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__title">import</span> <span class="code-snippet__params">(</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"net"</span></span></code><br><code><span class="code-snippet_outer">)</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet_outer">func <span class="code-snippet__title">main</span><span class="code-snippet__params">()</span> </span>{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;c, err := net.Dial(<span class="code-snippet__string">"tcp"</span>, <span class="code-snippet__string">"internal.domain.name:80"</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> err != nil {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;_ = c.Close()</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">dlv debug main.go</span></code><br><code><span class="code-snippet_outer">(dlv) <span class="code-snippet__keyword">break</span> /usr/local/go/src/net/dnsclient_unix.go:<span class="code-snippet__number">279</span></span></code><br><code><span class="code-snippet_outer">(dlv) <span class="code-snippet__keyword">break</span> /usr/local/go/src/net/dnsclient_unix.go:<span class="code-snippet__number">297</span></span></code><br><code><span class="code-snippet_outer">(dlv) <span class="code-snippet__keyword">continue</span></span></code><br><code><span class="code-snippet_outer">(dlv) <span class="code-snippet__function">print err</span></span></code><br><code><span class="code-snippet_outer"><span class="code-snippet_outer"><span class="code-snippet__title">error</span><span class="code-snippet__params">(*errors.errorString)</span> *</span>{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;s: <span class="code-snippet__string">"lame referral"</span>,}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">通过 debug 我们最终定位到 err 由下面这段代码抛出。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__function">func <span class="code-snippet__title">checkHeader</span><span class="code-snippet__params">(p *dnsmessage.Parser, h dnsmessage.Header)</span> error </span>{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;...</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__comment">// libresolv continues to the next server when it receives</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__comment">// an invalid referral response. See golang.org/issue/15434.</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> h.RCode == dnsmessage.RCodeSuccess &amp;&amp; !h.Authoritative &amp;&amp; !h.RecursionAvailable &amp;&amp; err == dnsmessage.ErrSectionDone {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> errLameReferral</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;....</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">原来如果返回的 DNS response 以下4个条件全部满足，就会触发重试逻辑：</p><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">响应没有错误</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">应答 Server 不是权威服务器</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">应答 Server 不支持递归请求</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">应答的&nbsp;records&nbsp;为 空</p></li></ol><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">这里有一个疑 点是我们的 DNS Server 是支持递归请求的，经过排查，我们发现是因为在 DNS Server 有一层 NetScaler 作为负载均衡器，负载均衡是以 DNS proxy server 的方式运行，默认并没有开启对递归请求的支持。</p><p style="word-break: break-all;white-space: normal;">我们可以运行 dig 命令观察是否有如下输出来判断 server 是否支持递归 请求。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">;; WARNING: recursion requested but <span class="code-snippet__keyword">not</span> available</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: left;" powered-by="xiumi.us"><div style="display: inline-block;"><p style="width: 0.7em;height: 0.7em;margin-right: 5px;margin-top: 0.5em;display: inline-block;vertical-align: top;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;text-align: center;font-size: 18px;color: rgb(12, 182, 242);"><p><strong>3. 原因梳理</strong></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">至此，我们已经弄清楚了为什么会有 AAAA 类型的请求发送到 nameserver2。而文章开头提到的业务 http  请求耗时增加 1s 的原因则是因为 client 到 server2 网络异常时，需要等待重试的 AAAA 请求超时，才会返回解析结果。</p><p style="word-break: break-all;white-space: normal;">还有一个问题困扰着我们，为什么用 ping  等程序验证，并没有发现类似的问题。我们通过直接用 C getaddrinfo 函数测试，以及通过 -tags 'netcgo' 编译相同的 go 程序验证，发现在 A 记录有值的情况下，AAAA 请求都不会重试到下一个 nameserver。回到 Go 中触发重试的这段代码深入分析，注释中可以看到由&nbsp;golang.org/issue/15434&nbsp;引入，提交代码的作者是为了解决 issue 中的问题复制了 libresolv 的行为。然而翻阅 glibc 的代码可以看到 next_ns 中还有这样一段逻辑：只要 A  或者 AAAA 任意一个有记录值，都不会重试到下一个 nameserver。这段逻辑并没有引入 Go 中。所以我们需要注意 Go 内置解析器与 glibc 中的行为和结果都有差异，它可能会影响到我们的服务。</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">next_ns:</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> (recvresp1 || (buf2 != <span class="code-snippet__literal">NULL</span> &amp;&amp; recvresp2)) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;*resplen2 = <span class="code-snippet__number">0</span>;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> resplen;</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer">...</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__keyword">if</span> (anhp-&gt;rcode == NOERROR &amp;&amp; anhp-&gt;ancount == <span class="code-snippet__number">0</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;&amp;&amp; anhp-&gt;aa == <span class="code-snippet__number">0</span> &amp;&amp; anhp-&gt;ra == <span class="code-snippet__number">0</span> &amp;&amp; anhp-&gt;arcount == <span class="code-snippet__number">0</span>) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">goto</span> next_ns;</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>三. 优化</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">经过上面的排查，我们已经确认了 AAAA 请求的源头，以及为什么会重试到下一个 server。接下来可以针对性的优化。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">1.&nbsp; 对于 Go 程序中 AAAA 请求重试到下一个 server 的优化方案：</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">&nbsp; a. 代价相对较小的方案，程序构建时添加&nbsp;-tags 'netcgo' 编译参数 ，指定使用 cgo-based 解析器。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">&nbsp; b. DNS Server proxy 层支持递归请求。这里有必要说明递归支持不能在 proxy 层简单的直接开启，proxy 和 recursion 在逻辑上有冲突的地方，务必做好必要的验证和确认，否则可能会带来新的问题。</p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;">2. 如果业务程序不需要支持 IPv6 网络，可 以通过指定网络类型为 IPv4，来消除 AAAA 请求，同时避免随之带来的问题。（也顺带减少了相关开销）</p><p style="word-break: break-all;white-space: normal;">&nbsp; &nbsp;a.&nbsp;<span style="color: rgb(255, 102, 149);">net.Dial</span>&nbsp;相关方法可以指定&nbsp;<span style="color: rgb(255, 102, 149);">network&nbsp;</span>为&nbsp;<span style="color: rgb(255, 102, 149);">tcp4</span>、<span style="color: rgb(255, 102, 149);">udp4</span>&nbsp;来强制使用 IPv4</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer">net.Dial(<span class="code-snippet__string">"tcp4"</span>, <span class="code-snippet__string">"internal.domain.name:443"</span>)</span></code><br><code><span class="code-snippet_outer">net.Dial(<span class="code-snippet__string">"udp4"</span>, <span class="code-snippet__string">"internal.domain.name:443"</span>)</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;">&nbsp; b.&nbsp;<span style="color: rgb(255, 102, 149);">net/http&nbsp;</span>相关方法可以通过如下示例来强制使用 IPv4</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p class="code-snippet__fix code-snippet__js"><pre class="code-snippet__js" data-lang="c"><code><span class="code-snippet_outer"><span class="code-snippet__function">package main</span></span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet__title">import</span> <span class="code-snippet__params">(</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"context"</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"log"</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"net"</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"net/http"</span></span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__string">"time"</span></span></code><br><code><span class="code-snippet_outer">)</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"><span class="code-snippet_outer">func <span class="code-snippet__title">main</span><span class="code-snippet__params">()</span> </span>{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;dialer := &amp;net.Dialer{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;Timeout: &nbsp; <span class="code-snippet__number">30</span> * time.Second,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;KeepAlive: <span class="code-snippet__number">30</span> * time.Second,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;transport := http.DefaultTransport.(*http.Transport).Clone()</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;transport.DialContext = func(ctx context.Context, network, addr <span class="code-snippet__built_in">string</span>) (net.Conn, error) {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__keyword">return</span> dialer.DialContext(ctx, <span class="code-snippet__string">"tcp4"</span>, addr)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;httpClient := &amp;http.Client{</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;Timeout: <span class="code-snippet__number">30</span> * time.Second,</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;httpClient.Transport = transport</span></code><br><code><span class="code-snippet_outer"> </span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;resp, err := httpClient.Get(<span class="code-snippet__string">"https://internal.domain.name"</span>)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__keyword">if</span> err != nil {</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="code-snippet__built_in">log</span>.Fatal(err)</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;}</span></code><br><code><span class="code-snippet_outer"> &nbsp; &nbsp;<span class="code-snippet__built_in">log</span>.Println(resp.StatusCode)</span></code><br><code><span class="code-snippet_outer">}</span></code><br></pre></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="margin-top: 10px;margin-bottom: 10px;text-align: center;" powered-by="xiumi.us"><div style="display: inline-block;vertical-align: top;padding-left: 10px;"><div style="border-bottom: 1px dashed rgb(0, 0, 0);padding-left: 5px;font-size: 20px;color: rgb(12, 182, 242);"><p><strong>四. 总结</strong></p></div><div style="margin-top: -7px;margin-left: -10px;width: 10px;"><p style="transform: rotate(0deg);margin-left: auto;width: 7px;height: 7px;background-color: rgb(255, 102, 149);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><p style="margin-top: -4px;margin-left: -3px;width: 10px;height: 10px;background-color: rgb(12, 182, 242);"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><ol class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="word-break: break-all;margin-bottom: 15px;">Go net 库中提供了两种解析逻辑：自实现的内置解析器和系统提供的解析函数。windows&nbsp;、darwin(MacOS等)优先使用系统提供的解析函数，常见的 Debain、Centos 等优先使用内置解析器。</p></li><li><p style="word-break: break-all;margin-bottom: 15px;">Go net 库中的内置解析器和系统提供的解析函数行为和结果并不完全一致，它可能会影响到我们的服务。</p></li><li><p>业务应设置合理的超时时间，不易过短，以确保基础设施的 failover 策略有 足够的响应时间。</p></li></ol></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="padding-right: 8px;padding-left: 8px;" powered-by="xiumi.us"><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><strong>推荐阅读：</strong></p><p style="word-break: break-all;margin-bottom: 15px;white-space: normal;"><span style="text-decoration: underline;color: rgb(12, 182, 242);"><em>https://studygolang.com/topics/15021</em></span></p><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(12, 182, 242);"><em><span style="text-decoration: underline;">https://pkg.go.dev/net</span></em></span>&nbsp;中的 Name Resolution 章节</p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>开发者问答</strong></p></div></div></div><div style="padding-right: 8px;padding-left: 8px;font-size: 13px;" powered-by="xiumi.us"><p style="word-break: break-all;white-space: normal;"><span style="color: rgb(255, 102, 149);"><strong>你还遇到过哪些域名解析相关的故障？</strong></span>欢迎在留言区告诉我们。转发并留言，小编将选取1则最有价值的评论，送出<span style="text-decoration: underline;"><strong>哔哩哔哩双层六芒星玻璃杯1个</strong></span>（见下图）。<strong><span style="color: rgb(255, 102, 149);">2月23日中午</span></strong><span style="color: rgb(255, 102, 149);"><strong>12点开奖。如果喜欢本期内容的话，欢迎点个“在看”吧！</strong></span></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;margin-top: 10px;margin-bottom: 10px;line-height: 0;" powered-by="xiumi.us"><p style="vertical-align: middle;display: inline-block;line-height: 0;width: 45%;height: auto;"><img class="rich_pages wxw-img" data-imgfileid="100014712" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="800" style="vertical-align: middle;width: 100%;" src="https://mmbiz.qpic.cn/mmbiz_jpg/1BMf5Ir754RFIjDhHyCfk6jU6tYC7ggj23dIr7SFjltHpHPsdgCYKJO3Ks9UBico9jQicxncNewuWgTv7um8qAeQ/640?wx_fmt=jpeg&amp;from=appmsg"></p></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;justify-content: center;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><p style="display: inline-block;vertical-align: top;width: auto;min-width: 5%;flex: 0 0 auto;height: auto;padding-right: 5px;"><svg viewBox="0 0 1 1" style="float:left;line-height:0;width:0;vertical-align:top;"></svg></p><div style="display: inline-block;vertical-align: top;width: auto;align-self: flex-start;flex: 0 0 auto;border-style: solid;border-width: 0px 0px 1px;border-color: rgb(30, 88, 134);min-width: 5%;height: auto;padding: 5px;"><div style="text-align: justify;color: rgb(12, 182, 242);" powered-by="xiumi.us"><p style="white-space: normal;"><strong>往期精彩指路</strong></p></div></div></div><div style="text-align: left;justify-content: flex-start;display: flex;flex-flow: row nowrap;margin-top: 5px;margin-bottom: 10px;" powered-by="xiumi.us"><div style="display: inline-block;width: 100%;vertical-align: top;align-self: flex-start;flex: 0 0 auto;background-color: rgba(234, 244, 255, 0.34);padding: 25px;height: auto;"><div style="transform: translate3d(-5px, 0px, 0px);" powered-by="xiumi.us"><div style="text-align: justify;padding-right: 8px;padding-left: 8px;font-size: 13px;"><ul class="list-paddingleft-1" style="padding-left: 40px;list-style-position: outside;"><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247487748&amp;idx=1&amp;sn=c9cbcacf3bba25b478abf2a0f5c0e75f&amp;chksm=cf2cd421f85b5d37adce8fc782151942912bf38a24be2ebd42b000505bcae60a4833d9a230cd&amp;scene=21#wechat_redirect" textvalue="全链路压测改造之全链自动化测试实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">全链路压测改造之全链自动化测试实践</a></p></li><li><p style="margin-bottom: 15px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247493174&amp;idx=1&amp;sn=648bf0ffb5e31b1c211d22e636e2c3df&amp;chksm=cf2f2313f858aa0580dad7ee9b8347739122dcaba50071616e444a73ad28f4c3dcaf62c79f33&amp;scene=21#wechat_redirect" textvalue="哔哩哔哩⼤数据建设之路—实时DQC篇" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">哔哩哔哩⼤数据建设之路—实时DQC篇</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247491092&amp;idx=1&amp;sn=b09492563c760775ed61f75db1bd5822&amp;chksm=cf2cdb31f85b5227b96a3da04fd89153c40635ce4d9ae20cbe9baadc58dbae9e41060d3cd003&amp;scene=21#wechat_redirect" textvalue="Apache Kyuubi 在B站 大数据场景下的应用实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Apache Kyuubi 在B站大数据场景下的应用实践</a></p></li></ul></div></div></div></div><p style="white-space: normal;" powered-by="xiumi.us"><br></p><div style="text-align: center;font-size: 13px;letter-spacing: 4px;" powered-by="xiumi.us"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3289447926347317252#wechat_redirect" textvalue="通用工程" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">通用工程</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2390333109742534656#wechat_redirect" textvalue="大前端" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">大前端</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=3297757408550699008#wechat_redirect" textvalue="业务线" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">业务线</span></a><br></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2329861166598127619#wechat_redirect" textvalue="大数据" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">大数据</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2782124818895699969#wechat_redirect" textvalue="AI" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">AI</span></a>丨<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3Njc0NTgwMg==&amp;action=getalbum&amp;album_id=2532608330440081409#wechat_redirect" textvalue="多媒体" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><span style="color: rgb(12, 182, 242);">多媒体</span></a></p><p><span style="color: rgb(12, 182, 242);"><br></span></p></div></div><p class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="Mzg3Njc0NTgwMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/1BMf5Ir754QyhiatboUJGZpnzrVDJZCDFYOWhcbdbvj2TlhSXVeErhqCZ8CzgHob1wNDy9IUl4HJheIaIrzgN3A/0?wx_fmt=png" data-nickname="哔哩哔哩技术" data-alias="bilibili-TC" data-signature="提供B站相关技术的介绍和讲解" data-from="0" data-is_biz_ban="0"></mp-common-profile></p><p class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzUxNTE4OTc0Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EVKwaZXNTl9OCCo7pxLHz2e2I3kV3rTPao5LlIickfJS79DNd2yjqjfYEtwtMOyVuKhJoDIq6UU4U9TQbjvOLaQ/0?wx_fmt=png" data-nickname="哔哩哔哩招聘" data-alias="" data-signature="生产快乐的地方" data-from="0" data-is_biz_ban="0"></mp-common-profile></p><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p>